

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1. Summary for node2 &mdash; BLSNT BLOG 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Docker基础与使用" href="../Docker/index.html" />
    <link rel="prev" title="SaltStack" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> BLSNT BLOG
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Python/index.html">Python入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Linux/index.html">Linux基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../golang/index.html">golang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ELK/index.html">ELK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Ansible/index.html">Ansible</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">SaltStack</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">1. Summary for node2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id79">2. Summary for node2</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Docker/index.html">Docker基础与使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MySQL/index.html">数据库</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BLSNT BLOG</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">SaltStack</a> &raquo;</li>
        
      <li><span class="section-number">1. </span>Summary for node2</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/SaltStack/SaltStack.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <ul class="simple">
<li><p>[环境准备](#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87)</p></li>
<li><p>[SaltStack四大功能](#saltstack%E5%9B%9B%E5%A4%A7%E5%8A%9F%E8%83%BD)</p></li>
<li><p>[SaltStack四种运行模式](#saltstack%E5%9B%9B%E7%A7%8D%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F)</p></li>
<li><p>[SaltStack-部署和认证](#saltstack-%E9%83%A8%E7%BD%B2%E5%92%8C%E8%AE%A4%E8%AF%81)</p></li>
<li><p>[SaltStack-远程执行](#saltstack-%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C)</p></li>
<li><p>[SaltStack-配置管理](#saltstack-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86)
* [SaltStack状态](#saltstack%E7%8A%B6%E6%80%81)
* [SaltStack高级状态](#saltstack%E9%AB%98%E7%BA%A7%E7%8A%B6%E6%80%81)</p></li>
<li><p>[SaltStack-SSH实战](#saltstack-ssh%E5%AE%9E%E6%88%98)</p></li>
<li><p>[SaltStack-Grains详解](#saltstack-grains%E8%AF%A6%E8%A7%A3)</p></li>
<li><p>[SaltStack-Pillar详解](#saltstack-pillar%E8%AF%A6%E8%A7%A3)</p></li>
<li><p>[SaltStack远程执行-执行模块](#saltstack%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C-%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9D%97)</p></li>
<li><p>[SaltStack远程执行-返回](#saltstack%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C-%E8%BF%94%E5%9B%9E)</p></li>
<li><p>[SaltStack配置管理-LAMP状态实现](#saltstack%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86-lamp%E7%8A%B6%E6%80%81%E5%AE%9E%E7%8E%B0)</p></li>
<li><p>[SaltStack-配置管理-jinja模板](#saltstack-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86-jinja%E6%A8%A1%E6%9D%BF)</p></li>
<li><p>[SaltStack-job管理](#saltstack-job%E7%AE%A1%E7%90%86)</p></li>
</ul>
<p>## 环境准备</p>
<ul class="simple">
<li><p>安装操作系统 CentOS-7.x-x86_64。</p></li>
<li><p>基本系统：1VCPU+2048M 内存+50G（动态）硬盘。</p>
<ul>
<li><p>网络选择：使用网络地址转换（NAT）。</p></li>
<li><p>软件包选择：Minimal Install。</p></li>
<li><p>关闭 iptables 和 SELinux。</p></li>
</ul>
</li>
<li><p>设置所有节点的主机名和 IP 地址，使用/etc/hosts 做好主机名解析</p></li>
</ul>
<p>## SaltStack四大功能</p>
<ul class="simple">
<li><p>远程执行</p></li>
<li><p>配置管理</p></li>
<li><p>云管理</p></li>
<li><p>事件驱动</p></li>
</ul>
<p>## SaltStack四种运行模式</p>
<ul class="simple">
<li><p>Local</p></li>
<li><p>Master/Minion</p></li>
<li><p>Salt SSH</p></li>
<li><p>Syndic(类似代理)</p></li>
</ul>
<p>## SaltStack-部署和认证</p>
<p>[SaltStack 官网部署方式](<a class="reference external" href="https://repo.saltstack.com/#rhel">https://repo.saltstack.com/#rhel</a>)</p>
<p>两台虚拟机都要安装</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">yum</span> <span class="pre">-y</span> <span class="pre">install</span> <span class="pre">https://repo.saltstack.com/yum/redhat/salt-repo-latest.el7.noarch.rpm</span>
<span class="pre">`</span></code></p>
<p>node1安装master和minion</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">yum</span> <span class="pre">-y</span> <span class="pre">install</span> <span class="pre">salt-master</span> <span class="pre">salt-minion</span>
<span class="pre">`</span></code></p>
<p>node2安装minion</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node2</span> <span class="pre">~]#</span> <span class="pre">yum</span> <span class="pre">-y</span> <span class="pre">install</span> <span class="pre">salt-minion</span>
<span class="pre">`</span></code></p>
<p>相当于node1为master即为客户端，node2为客户端</p>
<p>&gt; windows不支持master</p>
<p>node1启动master</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">salt-master.service</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">salt-master.service</span>
<span class="pre">`</span></code></p>
<p>node1修改minion配置并启动</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">vim</span> <span class="pre">/etc/salt/minion</span>
<span class="pre">master:</span> <span class="pre">192.168.11.50</span>
<span class="pre">id:</span> <span class="pre">node1</span>&#160;&#160;&#160; <span class="pre">#如果不修改，默认会用hostname的值</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">salt-minion</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">salt-minion</span>
<span class="pre">`</span></code></p>
<p>node2修改minion配置并启动</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node2</span> <span class="pre">~]#</span> <span class="pre">vim</span> <span class="pre">/etc/salt/minion</span>
<span class="pre">master:</span> <span class="pre">192.168.11.50</span>
<span class="pre">id:</span> <span class="pre">node2</span>
<span class="pre">[root&#64;node2</span> <span class="pre">~]#</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">salt-minion</span>
<span class="pre">[root&#64;node2</span> <span class="pre">~]#</span> <span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">salt-minion</span>
<span class="pre">`</span></code></p>
<p>node1同意所有minion请求的key从而**双向通信**</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt-key</span> <span class="pre">#列出客户端</span>
<span class="pre">Accepted</span> <span class="pre">Keys:</span>
<span class="pre">Denied</span> <span class="pre">Keys:</span>
<span class="pre">Unaccepted</span> <span class="pre">Keys:</span>
<span class="pre">node1</span>
<span class="pre">node2</span>
<span class="pre">Rejected</span> <span class="pre">Keys:</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt-key</span> <span class="pre">-a</span> <span class="pre">node1</span>&#160;&#160; <span class="pre">#同意单个客户端</span>
<span class="pre">The</span> <span class="pre">following</span> <span class="pre">keys</span> <span class="pre">are</span> <span class="pre">going</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">accepted:</span>
<span class="pre">Unaccepted</span> <span class="pre">Keys:</span>
<span class="pre">node1</span>
<span class="pre">Proceed?</span> <span class="pre">[n/Y]</span> <span class="pre">y</span>
<span class="pre">Key</span> <span class="pre">for</span> <span class="pre">minion</span> <span class="pre">node1</span> <span class="pre">accepted.</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt-key</span> <span class="pre">-A</span>&#160;&#160; <span class="pre">#同意所有客户端</span>
<span class="pre">The</span> <span class="pre">following</span> <span class="pre">keys</span> <span class="pre">are</span> <span class="pre">going</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">accepted:</span>
<span class="pre">Unaccepted</span> <span class="pre">Keys:</span>
<span class="pre">node2</span>
<span class="pre">Proceed?</span> <span class="pre">[n/Y]</span> <span class="pre">y</span>
<span class="pre">Key</span> <span class="pre">for</span> <span class="pre">minion</span> <span class="pre">node2</span> <span class="pre">accepted.</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt-key</span>&#160;&#160; <span class="pre">#查看发现已经全部同意</span>
<span class="pre">Accepted</span> <span class="pre">Keys:</span>
<span class="pre">node1</span>
<span class="pre">node2</span>
<span class="pre">Denied</span> <span class="pre">Keys:</span>
<span class="pre">Unaccepted</span> <span class="pre">Keys:</span>
<span class="pre">Rejected</span> <span class="pre">Keys:</span>
<span class="pre">`</span></code></p>
<p>master节点</p>
<p>&gt; /etc/salt/pki/master/minions_pre #放置的是未经master同意的key
&gt;
&gt; /etc/salt/pki/master/minions #放置的是已经通过salt-key同意的key</p>
<p>minion节点(客户端)</p>
<p>&gt; /etc/salt/pki #里面有存放master的公钥</p>
<p>如果修改了minion id怎么办</p>
<p>&gt; 客户端先停止minion，master然后删除使用salt-key -d id名，客户端启动minion，master salt-key同意就可以了</p>
<p>## SaltStack-远程执行</p>
<p>测试命令是否可以执行成功</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt ‘*’ test.ping  # 如下代表node和node2都没有问题，<a href="#id5"><span class="problematic" id="id6">*</span></a>代表所有机器，加单引号转义
node2:</p>
<blockquote>
<div><p>True</p>
</div></blockquote>
<dl class="simple">
<dt>node1:</dt><dd><p>True</p>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt ‘*’ cmd.run ‘df -h’ # 获取磁盘使用情况,cmd.run是超级命令
node1:</p>
<blockquote>
<div><p>Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2        19G  1.6G   18G   9% /
devtmpfs        479M     0  479M   0% /dev
tmpfs           489M   28K  489M   1% /dev/shm
tmpfs           489M  6.8M  482M   2% /run
tmpfs           489M     0  489M   0% /sys/fs/cgroup
/dev/sda1      1014M  120M  895M  12% /boot
tmpfs            98M     0   98M   0% /run/user/0</p>
</div></blockquote>
<dl class="simple">
<dt>node2:</dt><dd><p>Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2        19G  1.6G   18G   9% /
devtmpfs        479M     0  479M   0% /dev
tmpfs           489M   12K  489M   1% /dev/shm
tmpfs           489M  6.8M  482M   2% /run
tmpfs           489M     0  489M   0% /sys/fs/cgroup
/dev/sda1      1014M  120M  895M  12% /boot
tmpfs            98M     0   98M   0% /run/user/0</p>
</dd>
</dl>
<p><a href="#id7"><span class="problematic" id="id8">``</span></a><a href="#id9"><span class="problematic" id="id10">`</span></a></p>
<p>## SaltStack-配置管理</p>
<p>### SaltStack状态</p>
<p>状态管理-&gt;神笔马良</p>
<p>描述状态-&gt;SaltStack实现</p>
<p>&gt; 已经执行过的就不会再执行</p>
<p>YAML编写规范</p>
<ul class="simple">
<li><p>缩进
* YAML使用一个固定的缩进风格表示数据层结构关系，Salt 需要每个缩进级别由两个空格组成
* 不要使用talbe</p></li>
<li><p>冒号
* 每个key后面有一个冒号，冒号后面有个空格</p></li>
<li><p>短横线
* 想要表示列表项，使用一个短横杠加一个空格，多个项使用同样的缩进级别作为同一列表的一部分</p></li>
</ul>
<p>修改master 状态描述文件存放位置</p>
<p><a href="#id11"><span class="problematic" id="id12">``</span></a><a href="#id13"><span class="problematic" id="id14">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# vim /etc/salt/master
file_roots:</p>
<blockquote>
<div><dl class="simple">
<dt>base:</dt><dd><ul class="simple">
<li><p>/srv/salt</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# mkdir /srv/salt/web -p
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# systemctl restart salt-master
<a href="#id15"><span class="problematic" id="id16">``</span></a><a href="#id17"><span class="problematic" id="id18">`</span></a></p>
<p>写一个apache安装与启动的状态描述文件</p>
<p><a href="#id19"><span class="problematic" id="id20">``</span></a><a href="#id21"><span class="problematic" id="id22">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# cd /srv/salt/web
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> web]# vim apache.sls
apache-install:</p>
<blockquote>
<div><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>apache-service:</dt><dd><dl class="simple">
<dt>service.running:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
<li><p>enable: True</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>#使用node2执行这个状态
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> web]# salt ‘node2’ state.sls web.apache
node2:
———-</p>
<blockquote>
<div><blockquote>
<div><p>ID: apache-install</p>
</div></blockquote>
<dl>
<dt>Function: pkg.installed</dt><dd><blockquote>
<div><blockquote>
<div><p>Name: httpd</p>
</div></blockquote>
<p>Result: True</p>
</div></blockquote>
<p>Comment: The following packages were installed/updated: httpd
Started: 08:19:42.127389</p>
</dd>
<dt>Duration: 10713.988 ms</dt><dd><dl>
<dt>Changes:</dt><dd><dl>
<dt>httpd:</dt><dd><dl class="simple">
<dt>new:</dt><dd><p>2.4.6-89.el7.centos</p>
</dd>
</dl>
<p>old:</p>
</dd>
<dt>httpd-tools:</dt><dd><dl class="simple">
<dt>new:</dt><dd><p>2.4.6-89.el7.centos</p>
</dd>
</dl>
<p>old:</p>
</dd>
<dt>mailcap:</dt><dd><dl class="simple">
<dt>new:</dt><dd><p>2.1.41-2.el7</p>
</dd>
</dl>
<p>old:</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>Name: httpd</p>
</div></blockquote>
<p>Result: True</p>
</div></blockquote>
<p>Comment: Service httpd has been enabled, and is running
Started: 08:19:53.738830</p>
</div></blockquote>
<dl class="simple">
<dt>Duration: 233.833 ms</dt><dd><dl class="simple">
<dt>Changes:</dt><dd><dl class="simple">
<dt>httpd:</dt><dd><p>True</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<div class="section" id="summary-for-node2">
<h1><span class="section-number">1. </span>Summary for node2<a class="headerlink" href="#summary-for-node2" title="Permalink to this headline">¶</a></h1>
<p>Succeeded: 2 (changed=2)
Failed:    0
————
Total states run:     2
Total run time:  10.948 s
<a href="#id23"><span class="problematic" id="id24">``</span></a><a href="#id25"><span class="problematic" id="id26">`</span></a></p>
<p>### SaltStack高级状态</p>
<p><a href="#id27"><span class="problematic" id="id28">``</span></a><a href="#id29"><span class="problematic" id="id30">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# cd /srv/salt/
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> salt]# vim top.sls  #定义所有的客户端需要做的事情
base:</p>
<blockquote>
<div><dl class="simple">
<dt>‘node1’:</dt><dd><ul class="simple">
<li><p>web.apache</p></li>
</ul>
</dd>
<dt>‘node2’:</dt><dd><ul class="simple">
<li><p>web.apache</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> salt]# salt ‘*’ state.highstate #*代表所有客户端来查看top.sls并找到自己要做的事情。写单个客户端比如node1，node2 那么就是node1会来查看top.sls文件查看里面有没有自己需要执行的任务
<a href="#id31"><span class="problematic" id="id32">``</span></a><a href="#id33"><span class="problematic" id="id34">`</span></a></p>
<p>## SaltStack-SSH实战</p>
<p>master安装salt-ssh客户端不用安装，实现无agent</p>
<p><a href="#id35"><span class="problematic" id="id36">``</span></a><a href="#id37"><span class="problematic" id="id38">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# yum -y install salt-ssh
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# vim /etc/salt/roster
#web2:
#  host: 192.168.42.2
node1:</p>
<blockquote>
<div><p>host: 192.168.11.50
user: root
passwd: 666666</p>
</div></blockquote>
<dl class="simple">
<dt>node2:</dt><dd><p>host: 192.168.11.51
user: root
passwd: 666666</p>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt-ssh ‘*’ test.ping -i  #测试，使用-i免交互输入yes
node2:</p>
<blockquote>
<div><p>True</p>
</div></blockquote>
<dl class="simple">
<dt>node1:</dt><dd><p>True</p>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt-ssh ‘*’ -r ‘ifconfig’ #执行原生shell命令
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt-ssh ‘*’ cmd.run ‘w’   #执行模块使用命令
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt-ssh ‘*’ state.sls web.apache  #执行状态
<a href="#id39"><span class="problematic" id="id40">``</span></a><a href="#id41"><span class="problematic" id="id42">`</span></a></p>
<p>## SaltStack-Grains详解</p>
<ul class="simple">
<li><p>Minion启动时收集(静态数据)</p></li>
<li><p>Grains应用场景</p>
<ul>
<li><p>Grains 可以在state系统中使用，用于配置管理模块</p></li>
<li><p>Grains 可以在target中使用，在用来匹配Minion，比如匹配操作系统，使用-G选项</p></li>
<li><p>Grains 可以用于信息查询，Grains保存着收集到的客户端的详细信息</p></li>
</ul>
</li>
</ul>
<p>常规操作</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'node1'</span> <span class="pre">grains.ls</span> <span class="pre">#查看保存的系统信息key</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'node1'</span> <span class="pre">grains.items</span> <span class="pre">#查看所有信息的值</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'node1'</span> <span class="pre">grains.item</span> <span class="pre">saltversion</span> <span class="pre">#查看值</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'node1'</span> <span class="pre">grains.get</span> <span class="pre">saltversion</span>&#160; <span class="pre">#查看值</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'node1'</span> <span class="pre">grains.get</span> <span class="pre">ip4_interfaces:eth0</span> <span class="pre">#查看eth0的ip</span>
<span class="pre">`</span></code></p>
<p>自定义Grains</p>
<p><a href="#id43"><span class="problematic" id="id44">``</span></a><a href="#id45"><span class="problematic" id="id46">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# vim /etc/salt/grains
test-grains: test-grains-value
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt ‘*’ saltutil.sync_grains  # 不重启minion生效
node2:
node1:
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt ‘*’ grains.item test-grains
node1:</p>
<blockquote>
<div><dl class="simple">
<dt>test-grains:</dt><dd><p>test-grains-value</p>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>node2:</dt><dd></dd>
</dl>
<p><a href="#id47"><span class="problematic" id="id48">``</span></a><a href="#id49"><span class="problematic" id="id50">`</span></a></p>
<p>使用Grains过滤</p>
<p><a href="#id51"><span class="problematic" id="id52">``</span></a><a href="#id53"><span class="problematic" id="id54">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt -G ‘os:CentOS’ cmd.run ‘uptime’  # 过滤有CentOS的机器执行uptime
node1:</p>
<blockquote>
<div><p>13:36:54 up  5:05,  1 user,  load average: 0.01, 0.04, 0.05</p>
</div></blockquote>
<dl class="simple">
<dt>node2:</dt><dd><p>13:36:54 up  5:11,  1 user,  load average: 0.01, 0.04, 0.05</p>
</dd>
</dl>
<p><a href="#id55"><span class="problematic" id="id56">``</span></a><a href="#id57"><span class="problematic" id="id58">`</span></a></p>
<p>使用top.sls来写Grains</p>
<p><a href="#id59"><span class="problematic" id="id60">``</span></a><a href="#id61"><span class="problematic" id="id62">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# vim /srv/salt/top.sls
base:</p>
<blockquote>
<div><dl class="simple">
<dt>‘os:CentOS’:</dt><dd><ul class="simple">
<li><p>match: grain</p></li>
<li><p>web.apache</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt ‘*’ state.sls web.apache
<a href="#id63"><span class="problematic" id="id64">``</span></a><a href="#id65"><span class="problematic" id="id66">`</span></a></p>
<p>## SaltStack-Pillar详解</p>
<p>Salt 0.9.8 版本增加了pillar(动态数据)</p>
<p>存储位置：存储在master端，存放需要提供给minion的信息</p>
<p>应用场景：敏感信息，每个minion只能访问master分配给自己的pillar</p>
<p>修改pillar存储位置</p>
<p><a href="#id67"><span class="problematic" id="id68">``</span></a><a href="#id69"><span class="problematic" id="id70">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# vim  /etc/salt/master
pillar_roots:</p>
<blockquote>
<div><dl class="simple">
<dt>base:</dt><dd><ul class="simple">
<li><p>/srv/pillar</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# mkdir /srv/pillar -p
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# systemctl restart salt-master
<a href="#id71"><span class="problematic" id="id72">``</span></a><a href="#id73"><span class="problematic" id="id74">`</span></a></p>
<p>pillar配合grains</p>
<p><a href="#id75"><span class="problematic" id="id76">``</span></a><a href="#id77"><span class="problematic" id="id78">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# cd /srv/pillar/
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> pillar]# vim top.sls   #指定给哪个客户端用，apache指定apache.sls
base:</p>
<blockquote>
<div><dl class="simple">
<dt>‘node2’:</dt><dd><ul class="simple">
<li><p>apache</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> pillar]# vim apache.sls
{% if grains[‘os’] == ‘CentOS’ %}
apache: httpd
{% elif grains[‘os’] == ‘Debian’ %}
apache: apache2
{% endif %}
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> pillar]# salt ‘*’ pillar.items  #node1是没有指定的，所以只有node2
node1:</p>
<blockquote>
<div></div></blockquote>
<dl class="simple">
<dt>node2:</dt><dd><dl class="simple">
<dt>apache:</dt><dd><p>httpd</p>
</dd>
</dl>
</dd>
</dl>
<p># 配合grains
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# vim /srv/salt/web/apache.sls  #指定pillar下面的apache.sls
apache-install:</p>
<blockquote>
<div><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: {{ pillar[‘apache’] }}</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>apache-service:</dt><dd><dl class="simple">
<dt>service.running:</dt><dd><ul class="simple">
<li><p>name: {{ pillar[‘apache’] }}</p></li>
<li><p>enable: True</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> pillar]# salt ‘*’ state.highstate  #如果报错如下，则是pillar下的top.sls没有添加node1
node1:</p>
<blockquote>
<div><p>Data failed to compile:</p>
</div></blockquote>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><p>Name: httpd</p>
</div></blockquote>
<p>Result: True</p>
</div></blockquote>
<p>Comment: All specified packages are already installed
Started: 14:27:12.560070</p>
</div></blockquote>
<dl class="simple">
<dt>Duration: 726.908 ms</dt><dd><p>Changes:</p>
</dd>
</dl>
</div></blockquote>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><p>Name: httpd</p>
</div></blockquote>
<p>Result: True</p>
</div></blockquote>
<p>Comment: The service httpd is already running</p>
</div></blockquote>
<p>▽
base:</p>
<blockquote>
<div><blockquote>
<div><p>Started: 14:27:13.287826</p>
</div></blockquote>
<dl class="simple">
<dt>Duration: 26.24 ms</dt><dd><p>Changes:</p>
</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id79">
<h1><span class="section-number">2. </span>Summary for node2<a class="headerlink" href="#id79" title="Permalink to this headline">¶</a></h1>
<p>Succeeded: 2
Failed:    0
————
Total states run:     2
Total run time: 753.148 ms
ERROR: Minions returned with non-zero exit code</p>
<p>#修改为node*代表匹配包括node1和node2都会匹配到，再执行就不会报错了
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# cat /srv/pillar/top.sls
base:</p>
<blockquote>
<div><dl class="simple">
<dt>‘node*’:</dt><dd><ul class="simple">
<li><p>apache</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id80"><span class="problematic" id="id81">``</span></a><a href="#id82"><span class="problematic" id="id83">`</span></a></p>
<div class="line-block">
<div class="line-block">
<div class="line">| 存储位置 | 类型 | 采集方式               | 场景               |</div>
</div>
<div class="line">—— | ——– | —- | ———————- | —————— |</div>
<div class="line">Grains | minion   | 静态 | minion启动时，可以刷新 | 获取信息，匹配     |</div>
<div class="line">Pillar | master   | 动态 | 指定，实时生效         | 匹配，敏感数据配置 |</div>
</div>
<p>## SaltStack远程执行-执行模块</p>
<p>[官网模块](<a class="reference external" href="https://docs.saltstack.com/en/latest/ref/modules/all/index.html#all-salt-modules">https://docs.saltstack.com/en/latest/ref/modules/all/index.html#all-salt-modules</a>)</p>
<ul>
<li><p>service</p>
<ul class="simple">
<li><p>get_all 列出所有正在运行的服务</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'node2'</span> <span class="pre">service.get_all</span> <span class="pre">|grep</span> <span class="pre">sshd</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>Status 查看服务状态</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'node2'</span> <span class="pre">service.status</span> <span class="pre">sshd</span>
<span class="pre">`</span></code></p>
</li>
<li><p>state 状态模块</p>
<ul class="simple">
<li><p>show_top 查看minion有哪些状态</p></li>
</ul>
</li>
<li><p>salt-cp 拷贝文件</p></li>
</ul>
<p><a href="#id84"><span class="problematic" id="id85">``</span></a><a href="#id86"><span class="problematic" id="id87">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt-cp ‘*’ /etc/passwd /tmp/passwd  #拷贝文件到所有客户端
node1:</p>
<blockquote>
<div><dl class="simple">
<dt>/tmp/passwd:</dt><dd><p>True</p>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>node2:</dt><dd><dl class="simple">
<dt>/tmp/passwd:</dt><dd><p>True</p>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> ~]# salt ‘*’ cmd.run ‘head -1 /tmp/passwd’   #查看客户端是否拷贝成功
node1:</p>
<blockquote>
<div><p>root:x:0:0:root:/root:/bin/bash</p>
</div></blockquote>
<dl class="simple">
<dt>node2:</dt><dd><p>root:x:0:0:root:/root:/bin/bash</p>
</dd>
</dl>
<p><a href="#id88"><span class="problematic" id="id89">``</span></a><a href="#id90"><span class="problematic" id="id91">`</span></a></p>
<p>## SaltStack远程执行-返回</p>
<p><strong>所有minion安装mysql-python模块</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'*'</span> <span class="pre">cmd.run</span> <span class="pre">'yum</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">MySQL-python'</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'*'</span> <span class="pre">pkg.install</span> <span class="pre">MySQL-python</span>&#160; <span class="pre">#这样也可以</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">yum</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">mariadb-server</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">mariadb</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">mysql</span>
<span class="pre">MariaDB</span> <span class="pre">[(none)]&gt;</span> <span class="pre">grant</span> <span class="pre">all</span> <span class="pre">on</span> <span class="pre">salt.*</span> <span class="pre">to</span> <span class="pre">salt&#64;'%'</span> <span class="pre">identified</span> <span class="pre">by</span> <span class="pre">'salt';</span>
<span class="pre">`</span></code></p>
<p>执行sql语句</p>
<p><a href="#id92"><span class="problematic" id="id93">``</span></a><cite>shell
CREATE DATABASE  `salt</cite></p>
<blockquote>
<div><p>DEFAULT CHARACTER SET utf8
DEFAULT COLLATE utf8_general_ci;</p>
</div></blockquote>
<p>USE <cite>salt</cite>;</p>
<p>–
– Table structure for table <cite>jids</cite>
–</p>
<p>DROP TABLE IF EXISTS <cite>jids</cite>;
CREATE TABLE <cite>jids</cite> (</p>
<blockquote>
<div><p><cite>jid</cite> varchar(255) NOT NULL,
<cite>load</cite> mediumtext NOT NULL,
UNIQUE KEY <cite>jid</cite> (<cite>jid</cite>)</p>
</div></blockquote>
<p>) ENGINE=InnoDB DEFAULT CHARSET=utf8;
#CREATE INDEX jid ON jids(jid) USING BTREE;</p>
<p>–
– Table structure for table <cite>salt_returns</cite>
–</p>
<p>DROP TABLE IF EXISTS <cite>salt_returns</cite>;
CREATE TABLE <cite>salt_returns</cite> (</p>
<blockquote>
<div><p><cite>fun</cite> varchar(50) NOT NULL,
<cite>jid</cite> varchar(255) NOT NULL,
<cite>return</cite> mediumtext NOT NULL,
<cite>id</cite> varchar(255) NOT NULL,
<cite>success</cite> varchar(10) NOT NULL,
<cite>full_ret</cite> mediumtext NOT NULL,
<cite>alter_time</cite> TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
KEY <cite>id</cite> (<cite>id</cite>),
KEY <cite>jid</cite> (<cite>jid</cite>),
KEY <cite>fun</cite> (<cite>fun</cite>)</p>
</div></blockquote>
<p>) ENGINE=InnoDB DEFAULT CHARSET=utf8;</p>
<p>–
– Table structure for table <cite>salt_events</cite>
–</p>
<p>DROP TABLE IF EXISTS <cite>salt_events</cite>;
CREATE TABLE <cite>salt_events</cite> (
<cite>id</cite> BIGINT NOT NULL AUTO_INCREMENT,
<cite>tag</cite> varchar(255) NOT NULL,
<cite>data</cite> mediumtext NOT NULL,
<cite>alter_time</cite> TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
<cite>master_id</cite> varchar(255) NOT NULL,
PRIMARY KEY (<cite>id</cite>),
KEY <cite>tag</cite> (<cite>tag</cite>)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
<a href="#id94"><span class="problematic" id="id95">``</span></a><a href="#id96"><span class="problematic" id="id97">`</span></a></p>
<p><strong>minion更改配置文件，连接数据库</strong></p>
<p>## SaltStack配置管理-LAMP状态实现</p>
<p><a href="#id98"><span class="problematic" id="id99">``</span></a><a href="#id100"><span class="problematic" id="id101">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> prod]# tree
.
├── apache
│   ├── files  #这里面都是配置文件
│   │   └── httpd.conf
│   └── init.sls
├── mysql
│   ├── files
│   │   └── my.cnf
│   └── init.sls
└── php</p>
<blockquote>
<div><p>├── files
│   └── php.ini
└── init.sls</p>
</div></blockquote>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> prod]# cat apache/init.sls
apache-install:</p>
<blockquote>
<div><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>apache-config:</dt><dd><dl class="simple">
<dt>file.managed:</dt><dd><ul class="simple">
<li><p>name: /etc/httpd/conf/httpd.conf</p></li>
<li><p>source: salt://apache/files/httpd.conf</p></li>
<li><p>user: root</p></li>
<li><p>group: root</p></li>
<li><p>mode: 644</p></li>
</ul>
</dd>
</dl>
</dd>
<dt>apache-service:</dt><dd><dl class="simple">
<dt>service.running:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
<li><p>enable: True</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> prod]# cat php/init.sls
php-install:</p>
<blockquote>
<div><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>pkgs:
- php
- php-pdo
- php-mysql</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>php-config:</dt><dd><dl class="simple">
<dt>file.managed:</dt><dd><ul class="simple">
<li><p>name: /etc/php.ini</p></li>
<li><p>source: salt://php/files/php.ini</p></li>
<li><p>user: root</p></li>
<li><p>group: root</p></li>
<li><p>mode: 644</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> prod]# cat mysql/init.sls
mysql-install:</p>
<blockquote>
<div><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>pkgs:
- mariadb
- mariadb-server</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>mysql-config:</dt><dd><dl class="simple">
<dt>file.managed:</dt><dd><ul class="simple">
<li><p>name: /etc/my.cnf</p></li>
<li><p>source: salt://mysql/files/my.cnf</p></li>
<li><p>user: root</p></li>
<li><p>group: root</p></li>
<li><p>mode: 644</p></li>
</ul>
</dd>
</dl>
</dd>
<dt>mysql-service:</dt><dd><dl class="simple">
<dt>service.running:</dt><dd><ul class="simple">
<li><p>name: mariadb</p></li>
<li><p>enable: True</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> salt]# cat /srv/salt/top.sls
base:</p>
<blockquote>
<div><dl class="simple">
<dt>‘os:CentOS’:</dt><dd><ul class="simple">
<li><p>match: grain</p></li>
<li><p>web.apache</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>prod:</dt><dd><dl class="simple">
<dt>‘node*’:</dt><dd><ul class="simple">
<li><p>mysql.init</p></li>
<li><p>php.init</p></li>
<li><p>apache.init</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> salt]# salt ‘*’ state.highstate
<a href="#id102"><span class="problematic" id="id103">``</span></a><a href="#id104"><span class="problematic" id="id105">`</span></a></p>
<p><strong>saltstack include和扩展</strong></p>
<p><a href="#id106"><span class="problematic" id="id107">``</span></a><a href="#id108"><span class="problematic" id="id109">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> prod]# cat ../top.sls  #top文件定义lamp
base:</p>
<blockquote>
<div><dl class="simple">
<dt>‘os:CentOS’:</dt><dd><ul class="simple">
<li><p>match: grain</p></li>
<li><p>web.apache</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>prod:</dt><dd><dl class="simple">
<dt>‘node*’:</dt><dd><ul class="simple">
<li><p>lamp</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> prod]# cat lamp.sls  #调用include并添加扩展
include:</p>
<blockquote>
<div><ul class="simple">
<li><p>apache.init</p></li>
<li><p>php.init</p></li>
<li><p>mysql.init</p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt>extend:</dt><dd><dl class="simple">
<dt>php-install:</dt><dd><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: php-mbstring</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> salt]# salt ‘*’ state.highstate
<a href="#id110"><span class="problematic" id="id111">``</span></a><a href="#id112"><span class="problematic" id="id113">`</span></a></p>
<p><a href="#id114"><span class="problematic" id="id115">**</span></a>SaltStack require**(我依赖谁)</p>
<p><a href="#id116"><span class="problematic" id="id117">``</span></a><a href="#id118"><span class="problematic" id="id119">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> apache]# cat init.sls
apache-install:</p>
<blockquote>
<div><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>apache-config:</dt><dd><dl class="simple">
<dt>file.managed:</dt><dd><ul class="simple">
<li><p>name: /etc/httpd/conf/httpd.conf</p></li>
<li><p>source: salt://apache/files/httpd.conf</p></li>
<li><p>user: root</p></li>
<li><p>group: root</p></li>
<li><p>mode: 644</p></li>
</ul>
</dd>
</dl>
</dd>
<dt>apache-service:</dt><dd><dl class="simple">
<dt>service.running:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
<li><p>enable: True</p></li>
<li><p>require:             #固定字段
- pkg: apache-install  #如果安装失败也不会启动apache
- file: apache-config  #如果这个文件不存在，apache服务就不启动</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> salt]# salt ‘*’ state.highstate
<a href="#id120"><span class="problematic" id="id121">``</span></a><a href="#id122"><span class="problematic" id="id123">`</span></a></p>
<p><strong>SaltStack watch</strong></p>
<p><a href="#id124"><span class="problematic" id="id125">``</span></a><a href="#id126"><span class="problematic" id="id127">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> apache]# cat init.sls
apache-install:</p>
<blockquote>
<div><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>apache-config:</dt><dd><dl class="simple">
<dt>file.managed:</dt><dd><ul class="simple">
<li><p>name: /etc/httpd/conf/httpd.conf</p></li>
<li><p>source: salt://apache/files/httpd.conf</p></li>
<li><p>user: root</p></li>
<li><p>group: root</p></li>
<li><p>mode: 644</p></li>
</ul>
</dd>
</dl>
</dd>
<dt>apache-service:</dt><dd><dl class="simple">
<dt>service.running:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
<li><p>enable: True</p></li>
<li><p>reload: True.  #如果添加这个表示重载，不加表示重启</p></li>
<li><p>watch:         #如果apache的配置文件发生改变我就重启apache
- file: apache-config</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> salt]# salt ‘*’ state.highstate
<a href="#id128"><span class="problematic" id="id129">``</span></a><a href="#id130"><span class="problematic" id="id131">`</span></a></p>
<p>SaltStakck</p>
<p><a href="#id132"><span class="problematic" id="id133">``</span></a><a href="#id134"><span class="problematic" id="id135">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> apache]# cat init.sls
apache-install:</p>
<blockquote>
<div><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>apache-config:</dt><dd><dl class="simple">
<dt>file.managed:</dt><dd><ul class="simple">
<li><p>name: /etc/httpd/conf/httpd.conf</p></li>
<li><p>source: salt://apache/files/httpd.conf</p></li>
<li><p>user: root</p></li>
<li><p>group: root</p></li>
<li><p>mode: 644</p></li>
</ul>
</dd>
</dl>
</dd>
<dt>apache-auth:                    #配置访问apache需要用户认证</dt><dd><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: httpd-tools</p></li>
</ul>
</dd>
<dt>cmd.run:</dt><dd><ul class="simple">
<li><p>name: htpasswd -bc /etc/httpd/conf/htpasswd_file admin admin</p></li>
<li><p>unless: test -f /etc/httpd/conf/htpasswd_file  #如果已经有上面这个文件就不执行，如果没有则执行</p></li>
</ul>
</dd>
</dl>
</dd>
<dt>apache-service:</dt><dd><dl class="simple">
<dt>service.running:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
<li><p>enable: True</p></li>
<li><p>watch:
- file: apache-config</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>#需要自己在files里面的httpd.conf添加配置,admin目录自己创建，添加index.html
&lt;Directory “/var/www/html/admin”&gt;</p>
<blockquote>
<div><p>AllowOverride ALL
Order allow,deny
Allow from all
AuthType Basic
AuthName ‘hehe’
AuthUserFile /etc/httpd/conf/htpasswd_file
Require user admin</p>
</div></blockquote>
<p>&lt;/Directory&gt;
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> apache]# salt ‘node1’ state.highstate
<a href="#id136"><span class="problematic" id="id137">``</span></a><a href="#id138"><span class="problematic" id="id139">`</span></a></p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190801152703.png">http://images.dregs.top/images/20190801152703.png</a>)</p>
<p>## SaltStack-配置管理-jinja模板</p>
<p><a href="#id140"><span class="problematic" id="id141">``</span></a><a href="#id142"><span class="problematic" id="id143">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> apache]# cat init.sls
apache-install:</p>
<blockquote>
<div><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>apache-config:</dt><dd><dl class="simple">
<dt>file.managed:</dt><dd><ul class="simple">
<li><p>name: /etc/httpd/conf/httpd.conf</p></li>
<li><p>source: salt://apache/files/httpd.conf</p></li>
<li><p>user: root</p></li>
<li><p>group: root</p></li>
<li><p>mode: 644</p></li>
<li><p>template: jinja    #固定字段</p></li>
<li><p>defaults:          #将变量传入到上面的httpd.conf配置文件中
PORT: 80
IPADDR: {{ grains[‘fqdn_ip4’][0] }}  #从grains中获取到每台机器的ip，ip不能固定写死</p></li>
</ul>
</dd>
</dl>
</dd>
<dt>apache-auth:</dt><dd><dl class="simple">
<dt>pkg.installed:</dt><dd><ul class="simple">
<li><p>name: httpd-tools</p></li>
</ul>
</dd>
<dt>cmd.run:</dt><dd><ul class="simple">
<li><p>name: htpasswd -bc /etc/httpd/conf/htpasswd_file admin admin</p></li>
<li><p>unless: test -f /etc/httpd/conf/htpasswd_file</p></li>
</ul>
</dd>
</dl>
</dd>
<dt>apache-service:</dt><dd><dl class="simple">
<dt>service.running:</dt><dd><ul class="simple">
<li><p>name: httpd</p></li>
<li><p>enable: True</p></li>
<li><p>watch:
- file: apache-config</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> apache]# cat files/httpd.conf #httpd.conf 里面定义的变量
Listen {{ IPADDR }}:{{ PORT }}
[<a class="reference external" href="mailto:root&#37;&#52;&#48;node1">root<span>&#64;</span>node1</a> apache]# salt ‘*’ state.highstate
<a href="#id144"><span class="problematic" id="id145">``</span></a><a href="#id146"><span class="problematic" id="id147">`</span></a></p>
<p>## SaltStack-job管理</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;node1</span> <span class="pre">~]#</span> <span class="pre">salt</span> <span class="pre">'*'</span> <span class="pre">saltutil.running</span> <span class="pre">#查看正在运行的job</span>
<span class="pre">`</span></code></p>
<p>salt需求</p>
<ul class="simple">
<li><p>系统初始化</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">1.关闭selinux</span>
<span class="pre">2.关闭默认iptables</span>
<span class="pre">3.时间同步</span>
<span class="pre">4.内核调优</span>
<span class="pre">5.SSH服务优化</span>
<span class="pre">6.文件描述符</span>
<span class="pre">7.精简开机系统服务</span>
<span class="pre">8.DNS解析</span>
<span class="pre">9.字符集</span>
<span class="pre">10.hosts文件统一</span>
<span class="pre">11.历史记录优化history</span>
<span class="pre">12.设置终端超时时间</span>
<span class="pre">13.配置yum源</span>
<span class="pre">14.基础用户，用户审计</span>
<span class="pre">15.常用基础命令</span>
<span class="pre">16.</span>
<span class="pre">`</span></code></p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Docker/index.html" class="btn btn-neutral float-right" title="Docker基础与使用" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="SaltStack" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, 小义同学

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>