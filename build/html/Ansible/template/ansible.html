

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>&lt;no title&gt; &mdash; BLSNT BLOG 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> BLSNT BLOG
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Python/index.html">Python编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Linux/index.html">Linux基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ELK/index.html">ELK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Ansible</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BLSNT BLOG</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>&lt;no title&gt;</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/Ansible/template/ansible.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>[TOC]</p>
<p>## SSH批量分发脚本</p>
<blockquote>
<div><p><cite>gather_facts: no</cite> 来禁止 Ansible 收集 facts 信息，但是有时候又需要使用 facts 中的内容，这时候可以设置 facts 的缓存。</p>
</div></blockquote>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>python
#!/bin/bash
# create key pair</p>
<blockquote>
<div><p>rm /root/.ssh/id_rsa* -f
ssh-keygen -t rsa -f /root/.ssh/id_rsa -P “” &amp;&gt;/dev/null</p>
<p># fenfa
for ip in 7 31 41
do</p>
<blockquote>
<div><p>echo =====================172.16.1.$ip fenfa info==========================
sshpass -p123456 ssh-copy-id -i /root/.ssh/id_rsa.pub 172.16.1.$ip -o StrictHostKeyChecking=no
sshpass -p ‘666666’ ssh-copy-id -o StrictHostKeyChecking=no <a class="reference external" href="mailto:root&#37;&#52;&#48;192&#46;168&#46;2&#46;222">root<span>&#64;</span>192<span>&#46;</span>168<span>&#46;</span>2<span>&#46;</span>222</a>
echo =====================172.16.1.$ip fenfa end===========================
echo “”</p>
</div></blockquote>
<p>done</p>
</div></blockquote>
<p><a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a></p>
<p>## ansible安装</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">yum</span> <span class="pre">-y</span> <span class="pre">install</span> <span class="pre">ansible</span>
<span class="pre">`</span></code></p>
<p>## ansible命令使用</p>
<p>hosts配置主机清单</p>
<p><a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">`</span></a>python
vim /etc/ansible/hosts
[webserver]          # 分组
192.168.11.11:222    # 非22端口加端口号</p>
<p>[dbserver]
192.168.11.12</p>
<p>[appserver]
192.168.11.1[1:2]
<a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">`</span></a></p>
<p>输入密码执行ping测试</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">192.168.11.11</span> <span class="pre">-m</span> <span class="pre">ping</span> <span class="pre">-k</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">ping</span> <span class="pre">-k</span>&#160;&#160; <span class="pre">#</span> <span class="pre">all所有主机</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">command</span> <span class="pre">-a</span> <span class="pre">'ls</span> <span class="pre">/root'</span> <span class="pre">-u</span> <span class="pre">wang</span> <span class="pre">-k</span> <span class="pre">-b</span> <span class="pre">-K</span>&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">使用wang远程sudo</span> <span class="pre">root执行命令</span>
<span class="pre">`</span></code></p>
<p>取消key的检查并记录日志</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">vim</span> <span class="pre">/etc/ansible/ansible.cfg</span>
<span class="pre">host_key_checking</span> <span class="pre">=</span> <span class="pre">False</span>&#160; <span class="pre">#</span> <span class="pre">取消注释</span>
<span class="pre">log_path</span> <span class="pre">=</span> <span class="pre">/var/log/ansible.log</span>&#160; <span class="pre">#</span> <span class="pre">取消注释</span>
<span class="pre">`</span></code></p>
<p>查看被管理的所有主机</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">--list-hosts</span>
<span class="pre">ansible-inventory</span> <span class="pre">-i</span> <span class="pre">/etc/ansible/prod_hosts</span>&#160; <span class="pre">--graph</span>
<span class="pre">`</span></code></p>
<p>免密钥验证</p>
<p><a href="#id17"><span class="problematic" id="id18">``</span></a><a href="#id19"><span class="problematic" id="id20">`</span></a>python
ssh-keygen -t rsa # 一路回车</p>
<p>ssh-copy-id 192.168.11.11
<a href="#id21"><span class="problematic" id="id22">``</span></a><a href="#id23"><span class="problematic" id="id24">`</span></a></p>
<p>ansible的host-pattern</p>
<p><a href="#id25"><span class="problematic" id="id26">``</span></a><a href="#id27"><span class="problematic" id="id28">`</span></a>python
逻辑与:在webserver组并且在dbserver组中的主机
ansible “webserver:&amp;dbserver” -m ping</p>
<p>逻辑非:在webserver组，但不在dbserver组中的主机
ansible ‘webserver:!dbserver’ -m ping # 注意单引号</p>
<p>综合逻辑:即在webserver又在dbserver并且在appserver但是不在ftpserver中的主机
ansible ‘webserver:dbserver:&amp;appserver:!ftpserver’ -m ping
<a href="#id29"><span class="problematic" id="id30">``</span></a><a href="#id31"><span class="problematic" id="id32">`</span></a></p>
<p>## ansible常用模块详解</p>
<p>### lineinfile文本修改模块</p>
<p>详情请参考：<a class="reference external" href="https://www.cnblogs.com/jackchen001/p/6710233.html">https://www.cnblogs.com/jackchen001/p/6710233.html</a></p>
<p><strong>在匹配的内容前或后增加一行</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">[root&#64;master</span> <span class="pre">test]#</span> <span class="pre">cat</span> <span class="pre">http.conf</span>
<span class="pre">#Listen</span> <span class="pre">12.34.56.78:80</span>
<span class="pre">#Listen</span> <span class="pre">80</span>
<span class="pre">#Port</span>
<span class="pre">`</span></code></p>
<p>insertbefore匹配内容在前面添加</p>
<dl>
<dt><a href="#id33"><span class="problematic" id="id34">``</span></a><a href="#id35"><span class="problematic" id="id36">`</span></a>python</dt><dd><ul>
<li><p>name: httpd.conf modify 8080
lineinfile:</p>
<blockquote>
<div><p>dest: /opt/playbook/test/http.conf
regexp: ‘^Listen’
insertbefore: ‘^#Port’
line: ‘Listen 8080’</p>
</div></blockquote>
<dl class="simple">
<dt>tags:</dt><dd><ul class="simple">
<li><p>http8080</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
<p><a href="#id37"><span class="problematic" id="id38">``</span></a><a href="#id39"><span class="problematic" id="id40">`</span></a></p>
<p>验证</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">[root&#64;master</span> <span class="pre">test]#</span> <span class="pre">cat</span> <span class="pre">http.conf</span>
<span class="pre">#Listen</span> <span class="pre">12.34.56.78:80</span>
<span class="pre">#Listen</span> <span class="pre">80</span>
<span class="pre">Listen</span> <span class="pre">8080</span>
<span class="pre">#Port</span>
<span class="pre">`</span></code></p>
<blockquote>
<div><p>insertafter匹配内容在后面添加</p>
</div></blockquote>
<p><a href="#id41"><span class="problematic" id="id42">``</span></a><a href="#id43"><span class="problematic" id="id44">`</span></a>python
- name: httpd.conf modify 8080</p>
<blockquote>
<div><dl class="simple">
<dt>lineinfile:</dt><dd><p>dest: /opt/playbook/test/http.conf
regexp: ‘^Listen’
insertafter: ‘^#Port’
line: ‘Listen 8080’</p>
</dd>
<dt>tags:</dt><dd><ul class="simple">
<li><p>http8080</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id45"><span class="problematic" id="id46">``</span></a><a href="#id47"><span class="problematic" id="id48">`</span></a></p>
<p>验证</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">[root&#64;master</span> <span class="pre">test]#</span> <span class="pre">cat</span> <span class="pre">http.conf</span>
<span class="pre">#Listen</span> <span class="pre">12.34.56.78:80</span>
<span class="pre">#Listen</span> <span class="pre">80</span>
<span class="pre">#Port</span>
<span class="pre">Listen</span> <span class="pre">8080</span>
<span class="pre">`</span></code></p>
<p>实例：</p>
<p><a href="#id49"><span class="problematic" id="id50">``</span></a><a href="#id51"><span class="problematic" id="id52">`</span></a>python
—
- hosts: 172.16.4.159</p>
<blockquote>
<div><p>remote_user: root
vars:</p>
<blockquote>
<div><ul class="simple">
<li><p>app_name: ypsx-demo</p></li>
</ul>
</div></blockquote>
<dl>
<dt>tasks:</dt><dd><ul>
<li><p>name: updata filebeat.conf
lineinfile:</p>
<blockquote>
<div><p>dest: /root/ypsx.yml
insertafter: ‘paths:’
line: ‘    - /home/admin/logs/{{ 应用变量名 }}.log’</p>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id53"><span class="problematic" id="id54">``</span></a><a href="#id55"><span class="problematic" id="id56">`</span></a></p>
<p>### command模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">commmand</span> <span class="pre">-a</span> <span class="pre">'service</span> <span class="pre">vsftpd</span> <span class="pre">start'</span> <span class="pre">#</span> <span class="pre">默认模块，不支持$HOSTNAME</span> <span class="pre">&lt;</span> <span class="pre">&gt;</span> <span class="pre">|;</span> <span class="pre">&amp;等</span>
<span class="pre">`</span></code></p>
<p>### shell模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">shell</span> <span class="pre">-a</span> <span class="pre">&quot;hostname&quot;</span>&#160; <span class="pre">#</span> <span class="pre">支持管道符号,相当于shell执行命令</span>
<span class="pre">`</span></code></p>
<p>### script模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">script</span> <span class="pre">-a</span> <span class="pre">'/root/ansible/host.sh'</span>&#160; <span class="pre">#</span> <span class="pre">在ansible创建脚本，本地执行到远程机器</span>
<span class="pre">`</span></code></p>
<p>### copy模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">copy</span> <span class="pre">-a</span> <span class="pre">'src=/root/ansible/selinux</span> <span class="pre">dest=/etc/selinux/config</span> <span class="pre">backup=yes</span> <span class="pre">mode=644</span> <span class="pre">ower=root'</span> <span class="pre">#</span> <span class="pre">复制文件并备份源文件,修改权限，属主</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">copy</span> <span class="pre">-a</span> <span class="pre">'content=&quot;hello&quot;</span> <span class="pre">dest=/etc/test.txt</span> <span class="pre">backup=yes</span> <span class="pre">mode=644</span> <span class="pre">ower=root'</span>
<span class="pre">#</span> <span class="pre">自己写文件内容发送到服务器</span>
<span class="pre">`</span></code></p>
<p>### fetch模块</p>
<p>从客户端取文件至服务器端，copy相反,必须是单个文件</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">fetch</span> <span class="pre">-a</span> <span class="pre">'src=/var/log/messages</span> <span class="pre">dest=/data'</span>
<span class="pre">[root&#64;master</span> <span class="pre">.ssh]#</span> <span class="pre">ll</span> <span class="pre">/data</span>
<span class="pre">总用量</span> <span class="pre">0</span>
<span class="pre">drwxr-xr-x</span> <span class="pre">3</span> <span class="pre">root</span> <span class="pre">root</span> <span class="pre">17</span> <span class="pre">10月</span> <span class="pre">18</span> <span class="pre">06:51</span> <span class="pre">192.168.11.11</span>
<span class="pre">drwxr-xr-x</span> <span class="pre">3</span> <span class="pre">root</span> <span class="pre">root</span> <span class="pre">17</span> <span class="pre">10月</span> <span class="pre">18</span> <span class="pre">06:51</span> <span class="pre">192.168.11.12</span>
<span class="pre">`</span></code></p>
<p>### file模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">file</span> <span class="pre">-a</span> <span class="pre">'path=/tmp/f3</span> <span class="pre">state=touch'</span>&#160; <span class="pre">#</span> <span class="pre">新建文件</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">file</span> <span class="pre">-a</span> <span class="pre">'path=/tmp/f3</span> <span class="pre">state=absent'</span>&#160; <span class="pre">#</span> <span class="pre">删除</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">file</span> <span class="pre">-a</span> <span class="pre">'path=/data/dir1</span> <span class="pre">state=directory'</span> <span class="pre">#</span> <span class="pre">新建文件夹</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">file</span> <span class="pre">-a</span> <span class="pre">'path=/data/dir1</span> <span class="pre">state=absent'</span> <span class="pre">#</span> <span class="pre">删除</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">file</span> <span class="pre">-a</span> <span class="pre">'path=/etc/fstab</span> <span class="pre">dest=/tmp/fstab.link</span> <span class="pre">state=link'</span> <span class="pre">#</span> <span class="pre">创建软连接</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">file</span> <span class="pre">-a</span> <span class="pre">'dest=/tmp/fstab.link</span> <span class="pre">state=absent'</span> <span class="pre">#</span> <span class="pre">创建软连接</span>
<span class="pre">`</span></code></p>
<p>### hostname模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">192.168.11.11</span> <span class="pre">-m</span> <span class="pre">hostname</span> <span class="pre">-a</span> <span class="pre">'name=node1'</span> <span class="pre">#</span> <span class="pre">修改主机名</span>
<span class="pre">`</span></code></p>
<p>### cron模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">192.168.11.11</span> <span class="pre">-m</span> <span class="pre">cron</span> <span class="pre">-a</span> <span class="pre">'minute=*</span> <span class="pre">hour=0</span> <span class="pre">day=*</span> <span class="pre">month=*</span> <span class="pre">weekday=1,3,5</span> <span class="pre">job=&quot;/usr/wall</span> <span class="pre">FBI</span> <span class="pre">warning&quot;</span>&#160; <span class="pre">name=warningcron'</span>&#160; <span class="pre">#</span> <span class="pre">设置定时任务</span>
<span class="pre">ansible</span> <span class="pre">192.168.11.11</span> <span class="pre">-m</span> <span class="pre">cron</span> <span class="pre">-a</span> <span class="pre">'disabled=true</span> <span class="pre">job=&quot;/usr/wall</span> <span class="pre">FBI</span> <span class="pre">warning&quot;</span>&#160; <span class="pre">name=warningcron'</span>&#160; <span class="pre">#</span> <span class="pre">注释定时任务</span>
<span class="pre">`</span></code></p>
<p>### yum模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">yum</span> <span class="pre">-a</span> <span class="pre">'name=vsftpd'</span>&#160; <span class="pre">#</span> <span class="pre">安装，多个使用,分割</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">yum</span> <span class="pre">-a</span> <span class="pre">'name=vsftpd</span> <span class="pre">state=absent'</span>&#160; <span class="pre">#</span> <span class="pre">卸载</span>
<span class="pre">`</span></code></p>
<p>### service模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">service</span> <span class="pre">-a</span> <span class="pre">'name=vsftpd</span> <span class="pre">state=started</span> <span class="pre">enabled=yes'</span> <span class="pre">#</span> <span class="pre">启动并且开机自启动</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">service</span> <span class="pre">-a</span> <span class="pre">'name=vsftpd</span> <span class="pre">state=restarted'</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">service</span> <span class="pre">-a</span> <span class="pre">'name=vsftpd</span> <span class="pre">state=stopped'</span>
<span class="pre">`</span></code></p>
<p>### user模块</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">user</span> <span class="pre">-a</span> <span class="pre">'name=nginx</span> <span class="pre">shell=/sbin/nologin</span> <span class="pre">system=yes</span> <span class="pre">home=/home/nginx'</span>
<span class="pre">ansible</span> <span class="pre">all</span> <span class="pre">-m</span> <span class="pre">user</span> <span class="pre">-a</span> <span class="pre">'name=nginx</span> <span class="pre">state=absent</span> <span class="pre">remove=yes'</span>
<span class="pre">`</span></code></p>
<p>### ansible-galaxy</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible-galaxy</span> <span class="pre">install</span> <span class="pre">geerlingguy.nginx</span>
<span class="pre">ansible-galaxy</span> <span class="pre">list</span> <span class="pre">geerlingguy.nginx</span>
<span class="pre">ansible-galaxy</span> <span class="pre">remove</span> <span class="pre">geerlingguy.nginx</span>
<span class="pre">`</span></code></p>
<p>### 对文件进行加密</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible-vault</span> <span class="pre">encrype</span> <span class="pre">hello.yml</span>&#160; <span class="pre">#</span> <span class="pre">输入口令</span>
<span class="pre">ansible-vault</span> <span class="pre">decrypt</span> <span class="pre">hello.yml</span>&#160; <span class="pre">#</span> <span class="pre">输入口令</span>
<span class="pre">ansible-vault</span> <span class="pre">rekey</span> <span class="pre">hello.yml</span>&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">修改口令</span>
<span class="pre">`</span></code></p>
<p>### ansible-console</p>
<p><a href="#id57"><span class="problematic" id="id58">``</span></a><a href="#id59"><span class="problematic" id="id60">`</span></a>python
<a class="reference external" href="mailto:root&#37;&#52;&#48;webserver">root<span>&#64;</span>webserver</a> (1)[f:5]$
[root&#64;master ~]# ansible-console
Welcome to the ansible console.
Type help or ? to list commands.</p>
<p><a class="reference external" href="mailto:root&#37;&#52;&#48;all">root<span>&#64;</span>all</a> (2)[f:5]$ cd webserver
root&#64;webserver (1)[f:5]$ forks 10
root&#64;webserver (1)[f:10]$ command hostname
192.168.11.11 | CHANGED | rc=0 &gt;&gt;
node1
<a href="#id61"><span class="problematic" id="id62">``</span></a><a href="#id63"><span class="problematic" id="id64">`</span></a></p>
<p>## YAML语法简介</p>
<p>## ansible playbook基础</p>
<p>简单事列</p>
<p><a href="#id65"><span class="problematic" id="id66">``</span></a><a href="#id67"><span class="problematic" id="id68">`</span></a>python
—
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: hello
command: hostname</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id69"><span class="problematic" id="id70">``</span></a><a href="#id71"><span class="problematic" id="id72">`</span></a></p>
<p>### playbook变量，tags，handlers使用</p>
<p>#### handlers配合notify实现httpd配置发生变化自动重载配置</p>
<p><a href="#id73"><span class="problematic" id="id74">``</span></a><a href="#id75"><span class="problematic" id="id76">`</span></a>yaml
—
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: install package
yum: name=httpd</p></li>
<li><p>name: copy conf file
copy: src=files/httpd.conf dest=/etc/httpd/conf/ backup=yes
notify: restart service   # 配置文件修改之后就重启</p></li>
<li><p>name: start service
service: name=httpd state=started enabled=yes</p></li>
</ul>
</dd>
<dt>handlers:</dt><dd><ul class="simple">
<li><p>name: restart service
service: name=httpd state=restarted  # 对应上面的notify</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id77"><span class="problematic" id="id78">``</span></a><a href="#id79"><span class="problematic" id="id80">`</span></a></p>
<p>#### tags单独执行某个标签</p>
<p><a href="#id81"><span class="problematic" id="id82">``</span></a><a href="#id83"><span class="problematic" id="id84">`</span></a>yaml
—
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl>
<dt>tasks:</dt><dd><ul>
<li><p>name: install package
yum: name=httpd</p>
<blockquote>
<div><p>tags: inhttpd</p>
</div></blockquote>
</li>
<li><p>name: copy conf file
copy: src=files/httpd.conf dest=/etc/httpd/conf/ backup=yes
notify: restart service</p></li>
<li><p>name: start service
service: name=httpd state=started enabled=yes
tags: rshttpd</p></li>
</ul>
</dd>
<dt>handlers:</dt><dd><ul class="simple">
<li><p>name: restart service
service: name=httpd state=restarted</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id85"><span class="problematic" id="id86">``</span></a><a href="#id87"><span class="problematic" id="id88">`</span></a></p>
<p><code class="docutils literal notranslate"><span class="pre">`yaml</span>
<span class="pre">ansible-playbook</span> <span class="pre">-t</span> <span class="pre">rshttpd</span> <span class="pre">httpd.yml</span> <span class="pre">#</span> <span class="pre">单独执行某个标签</span>
<span class="pre">ansible-playbook</span> <span class="pre">-t</span> <span class="pre">rshttpd,inhttpd</span> <span class="pre">httpd.yml</span> <span class="pre">#</span> <span class="pre">执行多个标签</span>
<span class="pre">ansible-playbook</span> <span class="pre">-t</span> <span class="pre">rshttpd</span> <span class="pre">httpd.yml</span> <span class="pre">#</span> <span class="pre">多个tags可以共用一个标签</span>
<span class="pre">ansible-playbook</span> <span class="pre">httpd.yml</span> <span class="pre">--list-tags</span> <span class="pre">#</span> <span class="pre">查看标签信息</span>
<span class="pre">`</span></code></p>
<p>#### playbook变量指定单个变量</p>
<p><a href="#id89"><span class="problematic" id="id90">``</span></a><a href="#id91"><span class="problematic" id="id92">`</span></a>python
—
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: install package
yum: name={{ pkname }}</p></li>
<li><p>name: start service
service: name={{ pkname }} state=started enabled=yes</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id93"><span class="problematic" id="id94">``</span></a><a href="#id95"><span class="problematic" id="id96">`</span></a></p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible-playbook</span> <span class="pre">-e</span> <span class="pre">'pkname=vsftpd'</span> <span class="pre">package.yml</span> <span class="pre">#</span> <span class="pre">指定变量</span>
<span class="pre">`</span></code></p>
<p>#### playbook变量指定多个变量</p>
<p><a href="#id97"><span class="problematic" id="id98">``</span></a><a href="#id99"><span class="problematic" id="id100">`</span></a>python
—
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: install package
yum: name={{ pkname1 }}</p></li>
<li><p>name: install package
yum: name={{ pkname2 }}</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id101"><span class="problematic" id="id102">``</span></a><a href="#id103"><span class="problematic" id="id104">`</span></a></p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible-playbook</span> <span class="pre">-e</span> <span class="pre">'pkname1=vsftpd</span> <span class="pre">pkname2=redis'</span> <span class="pre">package.yml</span> <span class="pre">#</span> <span class="pre">指定变量</span>
<span class="pre">`</span></code></p>
<p>#### 声明变量</p>
<p><a href="#id105"><span class="problematic" id="id106">``</span></a><a href="#id107"><span class="problematic" id="id108">`</span></a>python
—
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root
vars:</p>
<blockquote>
<div><ul class="simple">
<li><p>pkname1: httpd</p></li>
<li><p>pkname2: redis</p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: install package
yum: name={{ pkname1 }}</p></li>
<li><p>name: install package
yum: name={{ pkname2 }}</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id109"><span class="problematic" id="id110">``</span></a><a href="#id111"><span class="problematic" id="id112">`</span></a></p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible-playbook</span> <span class="pre">package.yml</span>
<span class="pre">`</span></code></p>
<p>#### 在/etc/ansible/hosts 中定义单个变量</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">[dbserver]</span>
<span class="pre">192.168.11.12</span> <span class="pre">http_port=81</span>
<span class="pre">192.168.11.11</span> <span class="pre">http_port=82</span>
<span class="pre">`</span></code></p>
<p><a href="#id113"><span class="problematic" id="id114">``</span></a><a href="#id115"><span class="problematic" id="id116">`</span></a>python
—
- hosts: dbserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: set hostname
hostname: name=blsnt{{ http_port }}</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id117"><span class="problematic" id="id118">``</span></a><a href="#id119"><span class="problematic" id="id120">`</span></a></p>
<p><a href="#id121"><span class="problematic" id="id122">``</span></a><a href="#id123"><span class="problematic" id="id124">`</span></a>python
ansible-playbook host.yml
ansible dbserver -a ‘hostname’  # 已经修改
192.168.11.12 | CHANGED | rc=0 &gt;&gt;
blsnt81</p>
<p>192.168.11.11 | CHANGED | rc=0 &gt;&gt;
blsnt82</p>
<p><a href="#id125"><span class="problematic" id="id126">``</span></a><a href="#id127"><span class="problematic" id="id128">`</span></a></p>
<p>#### 在/etc/ansible/hosts 中定义组变量</p>
<p><a href="#id129"><span class="problematic" id="id130">``</span></a><a href="#id131"><span class="problematic" id="id132">`</span></a>python
[dbserver:vars]
nodename=www
domainname=blsnt</p>
<p>[dbserver]
192.168.11.12 http_port=81
192.168.11.11 http_port=82
<a href="#id133"><span class="problematic" id="id134">``</span></a><a href="#id135"><span class="problematic" id="id136">`</span></a></p>
<p><a href="#id137"><span class="problematic" id="id138">``</span></a><a href="#id139"><span class="problematic" id="id140">`</span></a>python
—
- hosts: dbserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: set hostname
hostname: name={{ nodename }}{{ http_port }}.{{ domainname }}</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id141"><span class="problematic" id="id142">``</span></a><a href="#id143"><span class="problematic" id="id144">`</span></a></p>
<p><a href="#id145"><span class="problematic" id="id146">``</span></a><a href="#id147"><span class="problematic" id="id148">`</span></a>python
ansible-playbook host.yml
ansible dbserver -a ‘hostname’
192.168.11.12 | CHANGED | rc=0 &gt;&gt;
www81.blsnt</p>
<p>192.168.11.11 | CHANGED | rc=0 &gt;&gt;
www82.blsnt
<a href="#id149"><span class="problematic" id="id150">``</span></a><a href="#id151"><span class="problematic" id="id152">`</span></a></p>
<p>#### 通过命令行执行变量优先级最高</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">ansible-playbook</span> <span class="pre">-e</span> <span class="pre">varname=value</span>
<span class="pre">`</span></code></p>
<p>#### 在playbook中定义</p>
<p><a href="#id153"><span class="problematic" id="id154">``</span></a><a href="#id155"><span class="problematic" id="id156">`</span></a>yml
vars:</p>
<blockquote>
<div><ul class="simple">
<li><p>var1: value1</p></li>
<li><p>var2: value2</p></li>
</ul>
</div></blockquote>
<p><a href="#id157"><span class="problematic" id="id158">``</span></a><a href="#id159"><span class="problematic" id="id160">`</span></a></p>
<p>#### 在独立变量yaml文件中定义</p>
<p><code class="docutils literal notranslate"><span class="pre">`yml</span>
<span class="pre">cat</span> <span class="pre">vars.yml</span>
<span class="pre">var1:</span> <span class="pre">httpd</span>
<span class="pre">var2:</span> <span class="pre">nginx</span>
<span class="pre">`</span></code></p>
<p>调用</p>
<p><a href="#id161"><span class="problematic" id="id162">``</span></a><a href="#id163"><span class="problematic" id="id164">`</span></a>yml
cat var.yml
- hosts: web</p>
<blockquote>
<div><p>remote_user: root
vars_files:</p>
<blockquote>
<div><ul class="simple">
<li><p>vars.yml</p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: create httpd log
file: name=/app/{{ var1 }}.log state=touch</p></li>
<li><p>name: create nginx log
file: name=/app/{{ var2 }}.log state=touch</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id165"><span class="problematic" id="id166">``</span></a><a href="#id167"><span class="problematic" id="id168">`</span></a></p>
<p>### playbook模板templates</p>
<p>通过ansible内置的变量自动设置nginx的worker数量</p>
<p><code class="docutils literal notranslate"><span class="pre">`yml</span>
<span class="pre">ansible</span> <span class="pre">webserver</span> <span class="pre">-m</span> <span class="pre">setup|grep</span> <span class="pre">&quot;cpu&quot;</span>
<span class="pre">ansible</span> <span class="pre">webserver</span> <span class="pre">-m</span> <span class="pre">setup</span> <span class="pre">-a</span> <span class="pre">'filter=ansible_os_family'</span>
<span class="pre">`</span></code></p>
<p>将nginx模板配置文件worker数量修改为变量，自动根据机器核数生成</p>
<p><code class="docutils literal notranslate"><span class="pre">`yml</span>
<span class="pre">worker_processes</span> <span class="pre">{{</span> <span class="pre">ansible_processor_vcpus</span> <span class="pre">}}</span>
<span class="pre">`</span></code></p>
<p><a href="#id169"><span class="problematic" id="id170">``</span></a><a href="#id171"><span class="problematic" id="id172">`</span></a>yml
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: install package
yum: name=nginx</p></li>
<li><p>name: copy templeate
template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</p></li>
<li><p>name: start service
service: name=nginx state=started enabled=yes</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id173"><span class="problematic" id="id174">``</span></a><a href="#id175"><span class="problematic" id="id176">`</span></a></p>
<p>### playbooke条件判断when</p>
<p><a href="#id177"><span class="problematic" id="id178">``</span></a><a href="#id179"><span class="problematic" id="id180">`</span></a>yml
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: install package
yum: name=nginx</p></li>
<li><p>name: copy templeate for centos7
template: src=nginx.conf7.j2 dest=/etc/nginx/nginx.conf
when: ansible_distribution_major_version == “7”</p></li>
<li><p>name: copy templeate for centos6
template: nginx.conf6.j2 dest=/etc/nginx/nginx.conf
when: ansible_distribution_major_version == “6”</p></li>
<li><p>name: start service
service: name=nginx state=started enabled=yes</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id181"><span class="problematic" id="id182">``</span></a><a href="#id183"><span class="problematic" id="id184">`</span></a></p>
<p>## playbook字典with_items</p>
<p><a href="#id185"><span class="problematic" id="id186">``</span></a><a href="#id187"><span class="problematic" id="id188">`</span></a>yml
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl>
<dt>tasks:</dt><dd><ul>
<li><p>name: create some file
file: name=/data/{{ item }} state=touch
when: ansible_distribution_major_version == “7”
with_items:</p>
<blockquote>
<div><ul class="simple">
<li><p>file1</p></li>
<li><p>file2</p></li>
<li><p>file3</p></li>
</ul>
</div></blockquote>
</li>
<li><p>name: install some packages
yum: name={{ item }}
with_items:</p>
<blockquote>
<div><ul class="simple">
<li><p>httpd</p></li>
<li><p>vsftpd</p></li>
<li><p>sl</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id189"><span class="problematic" id="id190">``</span></a><a href="#id191"><span class="problematic" id="id192">`</span></a></p>
<p><a href="#id193"><span class="problematic" id="id194">``</span></a><a href="#id195"><span class="problematic" id="id196">`</span></a>yml
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root</p>
<dl>
<dt>tasks:</dt><dd><ul>
<li><p>name: create some groups
group: name={{ item }}
when: ansible_distribution_major_version == “7”
with_items:</p>
<blockquote>
<div><ul class="simple">
<li><p>g1</p></li>
<li><p>g2</p></li>
<li><p>g3</p></li>
</ul>
</div></blockquote>
</li>
<li><p>name: create some users
user: name={{ item.name }} group={{ item.group }}
with_items:</p>
<blockquote>
<div><ul class="simple">
<li><p>{ name: ‘user1’, group: ‘g1’ }</p></li>
<li><p>{ name: ‘user2’, group: ‘g2’ }</p></li>
<li><p>{ name: ‘user3’, group: ‘g3’ }</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id197"><span class="problematic" id="id198">``</span></a><a href="#id199"><span class="problematic" id="id200">`</span></a></p>
<p>## playbook中template for if</p>
<p><a href="#id201"><span class="problematic" id="id202">``</span></a><a href="#id203"><span class="problematic" id="id204">`</span></a>yml
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root
vars:</p>
<blockquote>
<div><dl class="simple">
<dt>ports:</dt><dd><ul class="simple">
<li><p>81</p></li>
<li><p>82</p></li>
<li><p>83</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: copy conf
template: src=for1.conf.j2 dest=/data/for1.conf</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id205"><span class="problematic" id="id206">``</span></a><a href="#id207"><span class="problematic" id="id208">`</span></a></p>
<p><a href="#id209"><span class="problematic" id="id210">``</span></a><a href="#id211"><span class="problematic" id="id212">`</span></a>yml
vim for1.conf.j2
{% for port in ports %}
server{</p>
<blockquote>
<div><p>listen {{ port }}</p>
</div></blockquote>
<p>}
{% end %}
<a href="#id213"><span class="problematic" id="id214">``</span></a><a href="#id215"><span class="problematic" id="id216">`</span></a></p>
<p>高级用法</p>
<p><a href="#id217"><span class="problematic" id="id218">``</span></a><a href="#id219"><span class="problematic" id="id220">`</span></a>yml
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root
vars:</p>
<blockquote>
<div><dl>
<dt>ports:</dt><dd><ul>
<li><dl>
<dt>web1:</dt><dd><blockquote>
<div><p>port: 81
name: web1.blsnt.com
rootdir: /data/werb1</p>
</div></blockquote>
<ul class="simple">
<li><p>web2:
port: 82
name: web2.blsnt.com
rootdir: /data/web2</p></li>
<li><p>web3:
port: 83
name: web3.blsnt.com
rootdir: /data/web3</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: copy conf
template: src=for1.conf.j2 dest=/data/for1.conf</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id221"><span class="problematic" id="id222">``</span></a><a href="#id223"><span class="problematic" id="id224">`</span></a></p>
<p><a href="#id225"><span class="problematic" id="id226">``</span></a><a href="#id227"><span class="problematic" id="id228">`</span></a>yml
{% for p in ports %}
server{</p>
<blockquote>
<div><p>listen {{ p.port }}
servername {{ p.name }}
documentroot{{ p.rootdir }}</p>
</div></blockquote>
<p>}
{% end %}
<a href="#id229"><span class="problematic" id="id230">``</span></a><a href="#id231"><span class="problematic" id="id232">`</span></a></p>
<p>If 判断</p>
<p><a href="#id233"><span class="problematic" id="id234">``</span></a><a href="#id235"><span class="problematic" id="id236">`</span></a>yml
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root
vars:</p>
<blockquote>
<div><dl>
<dt>ports:</dt><dd><ul>
<li><dl>
<dt>web1:</dt><dd><blockquote>
<div><p>port: 81
#name: web1.blsnt.com
rootdir: /data/werb1</p>
</div></blockquote>
<ul class="simple">
<li><p>web2:
port: 82
name: web2.blsnt.com
rootdir: /data/web2</p></li>
<li><p>web3:
port: 83
name: web3.blsnt.com
rootdir: /data/web3</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>tasks:</dt><dd><ul class="simple">
<li><p>name: copy conf
template: src=for1.conf.j2 dest=/data/for1.conf</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p><a href="#id237"><span class="problematic" id="id238">``</span></a><a href="#id239"><span class="problematic" id="id240">`</span></a></p>
<p><a href="#id241"><span class="problematic" id="id242">``</span></a><a href="#id243"><span class="problematic" id="id244">`</span></a>yml
{% for p in ports %}
server{</p>
<blockquote>
<div><p>listen {{ p.port }}</p>
</div></blockquote>
<dl class="simple">
<dt>{% if p.name is defined $%}</dt><dd><p>servername {{ p.name }}</p>
</dd>
<dt>{% endif %}</dt><dd><p>documentroot{{ p.rootdir }}</p>
</dd>
</dl>
<p>}
{% end %}
<a href="#id245"><span class="problematic" id="id246">``</span></a><a href="#id247"><span class="problematic" id="id248">`</span></a></p>
<p>## ansible Roles</p>
<p>目录规范</p>
<p><a href="#id249"><span class="problematic" id="id250">``</span></a><a href="#id251"><span class="problematic" id="id252">`</span></a>python
# 推荐路径/etc/ansible
roles/</p>
<blockquote>
<div><dl>
<dt>nginx/</dt><dd><blockquote>
<div><p>file</p>
</div></blockquote>
<p>templates
tasks
handlers
vars</p>
</dd>
</dl>
</div></blockquote>
<p><a href="#id253"><span class="problematic" id="id254">``</span></a><a href="#id255"><span class="problematic" id="id256">`</span></a></p>
<p><a href="#id257"><span class="problematic" id="id258">``</span></a><a href="#id259"><span class="problematic" id="id260">`</span></a>yml
cat /etc/ansible/roles/nginx/tasks/group.yml
- name: create group</p>
<blockquote>
<div><p>group: name=nginx git=80</p>
</div></blockquote>
<p>cat /etc/ansible/roles/nginx/tasks/user.yml
- name: create user</p>
<blockquote>
<div><p>user: name=nginx uid=80 group=nginx system=yes shell=/sbin/nologin</p>
</div></blockquote>
<p>cat /etc/ansible/roles/nginx/tasks/yum.yml
- name: install package</p>
<blockquote>
<div><p>yum: name=nginx</p>
</div></blockquote>
<p>cat /etc/ansible/roles/nginx/tasks/start.yml
- name: start service</p>
<blockquote>
<div><p>service: name=nginx state=started enabled=yes</p>
</div></blockquote>
<p>cat /etc/ansible/roles/nginx/tasks/restart.yml
- name: restart service</p>
<blockquote>
<div><p>service: name=nginx state=restarted</p>
</div></blockquote>
<p>cat /etc/ansible/roles/nginx/tasks/templ.yml
- name: copy conf</p>
<blockquote>
<div><p>template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</p>
</div></blockquote>
<p>cat /etc/ansible/roles/nginx/tasks/main.yml
- include: group.yml
- include: user.yml
- include: yum.yml
- include: templ.yml
- include: start.yml</p>
<p>cat /etc/ansible/nginx_roles.yml
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root
roles:</p>
<blockquote>
<div><ul class="simple">
<li><p>role: nginx</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<p># 需要定义好模板文件，我这里就没有定义了
ansible-playbook nginx_roles.yml
<a href="#id261"><span class="problematic" id="id262">``</span></a><a href="#id263"><span class="problematic" id="id264">`</span></a></p>
<p>同时调用角色</p>
<blockquote>
<div><p><a href="#id265"><span class="problematic" id="id266">``</span></a><a href="#id267"><span class="problematic" id="id268">`</span></a>yml</p>
</div></blockquote>
<ul>
<li><p>hosts: webserver
remote_user: root
roles:</p>
<blockquote>
<div><ul class="simple">
<li><p>role: httpd</p></li>
<li><p>rele: redis</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<blockquote>
<div><p><a href="#id269"><span class="problematic" id="id270">``</span></a><a href="#id271"><span class="problematic" id="id272">`</span></a></p>
</div></blockquote>
<p>角色之间任务调用</p>
<dl class="simple">
<dt><a href="#id273"><span class="problematic" id="id274">``</span></a><a href="#id275"><span class="problematic" id="id276">`</span></a>yml</dt><dd><p>cat /etc/ansible/roles/nginx/tasks/main.yml</p>
</dd>
</dl>
<ul class="simple">
<li><p>include: group.yml</p></li>
<li><p>include: user.yml</p></li>
<li><p>include: yum.yml</p></li>
<li><p>include: templ.yml</p></li>
<li><p>include: start.yml</p></li>
<li><p>include: roles/httpd/tasks/copyfile.yml</p></li>
</ul>
<p><a href="#id277"><span class="problematic" id="id278">``</span></a><a href="#id279"><span class="problematic" id="id280">`</span></a></p>
<p>标签选择</p>
<p><a href="#id281"><span class="problematic" id="id282">``</span></a><a href="#id283"><span class="problematic" id="id284">`</span></a>yml
cat /etc/ansible/some.role.yml
- hosts: webserver</p>
<blockquote>
<div><p>remote_user: root
roles:</p>
<blockquote>
<div><ul class="simple">
<li><p>{ role: httpd, tags: [‘web’:’httpd’] }</p></li>
<li><p>{ role: nginx, tags: [‘web’:’nginx’] }</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<p>ansible-playbook -t web some_role.yml
<a href="#id285"><span class="problematic" id="id286">``</span></a><a href="#id287"><span class="problematic" id="id288">`</span></a></p>
<p>标签选择加判断</p>
<p><a href="#id289"><span class="problematic" id="id290">``</span></a><a href="#id291"><span class="problematic" id="id292">`</span></a>yml
- hosts: all</p>
<blockquote>
<div><p>remote_user: root
roles:</p>
<blockquote>
<div><ul class="simple">
<li><p>{ role: httpd, tags: [‘web’:’httpd’] }</p></li>
<li><p>{ role: nginx, tags: [‘web’:’nginx’],when: ansible_distribution_major_version == “7” }</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<p><a href="#id293"><span class="problematic" id="id294">``</span></a><a href="#id295"><span class="problematic" id="id296">`</span></a></p>
<p><a href="#id297"><span class="problematic" id="id298">``</span></a><a href="#id299"><span class="problematic" id="id300">`</span></a>python
include:</p>
<blockquote>
<div><ul class="simple">
<li><p>project: “arch-foundation/cicd”
ref: test
file: “/templates/Maven.gitlab-ci.yml”</p></li>
</ul>
</div></blockquote>
<p><a href="#id301"><span class="problematic" id="id302">``</span></a><a href="#id303"><span class="problematic" id="id304">`</span></a></p>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, 小义同学

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>