

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1. SSH批量分发脚本 &mdash; BLSNT BLOG 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Ansible" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> BLSNT BLOG
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Python/index.html">Python编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Linux/index.html">Linux基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ELK/index.html">ELK</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Ansible</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">1. SSH批量分发脚本</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ansible">2. ansible安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">3. ansible命令使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">4. ansible常用模块详解</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lineinfile">4.1. lineinfile文本修改模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#command">4.2. command模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shell">4.3. shell模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#script">4.4. script模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#copy">4.5. copy模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fetch">4.6. fetch模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#file">4.7. file模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hostname">4.8. hostname模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cron">4.9. cron模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#yum">4.10. yum模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#service">4.11. service模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user">4.12. user模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ansible-galaxy">4.13. ansible-galaxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">4.14. 对文件进行加密</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ansible-console">4.15. ansible-console</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#yaml">5. YAML语法简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ansible-playbook">6. ansible playbook基础</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#playbook-tags-handlers">6.1. playbook变量，tags，handlers使用</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#handlersnotifyhttpd">handlers配合notify实现httpd配置发生变化自动重载配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tags">tags单独执行某个标签</a></li>
<li class="toctree-l4"><a class="reference internal" href="#playbook">playbook变量指定单个变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">playbook变量指定多个变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">声明变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#etc-ansible-hosts">在/etc/ansible/hosts 中定义单个变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">在/etc/ansible/hosts 中定义组变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">通过命令行执行变量优先级最高</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">在playbook中定义</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">在独立变量yaml文件中定义</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#playbooktemplates">6.2. playbook模板templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#playbookewhen">6.3. playbooke条件判断when</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#playbookwith-items">7. playbook字典with_items</a></li>
<li class="toctree-l2"><a class="reference internal" href="#playbooktemplate-for-if">8. playbook中template for if</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ansible-roles">9. ansible Roles</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BLSNT BLOG</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Ansible</a> &raquo;</li>
        
      <li><span class="section-number">1. </span>SSH批量分发脚本</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Ansible/Ansible.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ssh" id="id10">SSH批量分发脚本</a></p></li>
<li><p><a class="reference internal" href="#ansible" id="id11">ansible安装</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id12">ansible命令使用</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id13">ansible常用模块详解</a></p>
<ul>
<li><p><a class="reference internal" href="#lineinfile" id="id14">lineinfile文本修改模块</a></p></li>
<li><p><a class="reference internal" href="#command" id="id15">command模块</a></p></li>
<li><p><a class="reference internal" href="#shell" id="id16">shell模块</a></p></li>
<li><p><a class="reference internal" href="#script" id="id17">script模块</a></p></li>
<li><p><a class="reference internal" href="#copy" id="id18">copy模块</a></p></li>
<li><p><a class="reference internal" href="#fetch" id="id19">fetch模块</a></p></li>
<li><p><a class="reference internal" href="#file" id="id20">file模块</a></p></li>
<li><p><a class="reference internal" href="#hostname" id="id21">hostname模块</a></p></li>
<li><p><a class="reference internal" href="#cron" id="id22">cron模块</a></p></li>
<li><p><a class="reference internal" href="#yum" id="id23">yum模块</a></p></li>
<li><p><a class="reference internal" href="#service" id="id24">service模块</a></p></li>
<li><p><a class="reference internal" href="#user" id="id25">user模块</a></p></li>
<li><p><a class="reference internal" href="#ansible-galaxy" id="id26">ansible-galaxy</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id27">对文件进行加密</a></p></li>
<li><p><a class="reference internal" href="#ansible-console" id="id28">ansible-console</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#yaml" id="id29">YAML语法简介</a></p></li>
<li><p><a class="reference internal" href="#ansible-playbook" id="id30">ansible playbook基础</a></p>
<ul>
<li><p><a class="reference internal" href="#playbook-tags-handlers" id="id31">playbook变量，tags，handlers使用</a></p>
<ul>
<li><p><a class="reference internal" href="#handlersnotifyhttpd" id="id32">handlers配合notify实现httpd配置发生变化自动重载配置</a></p></li>
<li><p><a class="reference internal" href="#tags" id="id33">tags单独执行某个标签</a></p></li>
<li><p><a class="reference internal" href="#playbook" id="id34">playbook变量指定单个变量</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id35">playbook变量指定多个变量</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id36">声明变量</a></p></li>
<li><p><a class="reference internal" href="#etc-ansible-hosts" id="id37">在/etc/ansible/hosts 中定义单个变量</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id38">在/etc/ansible/hosts 中定义组变量</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id39">通过命令行执行变量优先级最高</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id40">在playbook中定义</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id41">在独立变量yaml文件中定义</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#playbooktemplates" id="id42">playbook模板templates</a></p></li>
<li><p><a class="reference internal" href="#playbookewhen" id="id43">playbooke条件判断when</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#playbookwith-items" id="id44">playbook字典with_items</a></p></li>
<li><p><a class="reference internal" href="#playbooktemplate-for-if" id="id45">playbook中template for if</a></p></li>
<li><p><a class="reference internal" href="#ansible-roles" id="id46">ansible Roles</a></p></li>
</ul>
</div>
<div class="section" id="ssh">
<h1><a class="toc-backref" href="#id10"><span class="section-number">1. </span>SSH批量分发脚本</a><a class="headerlink" href="#ssh" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">gather_facts:</span> <span class="pre">no</span></code> 来禁止 Ansible 收集 facts
信息，但是有时候又需要使用 facts 中的内容，这时候可以设置 facts 的缓存。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
# create key pair
    \rm /root/.ssh/id_rsa* -f
    ssh-keygen -t rsa -f /root/.ssh/id_rsa -P &quot;&quot; &amp;&gt;/dev/null

    # fenfa
    for ip in 7 31 41
    do
      echo =====================172.16.1.$ip fenfa info==========================
      sshpass -p123456 ssh-copy-id -i /root/.ssh/id_rsa.pub 172.16.1.$ip -o StrictHostKeyChecking=no
      sshpass -p &#39;666666&#39; ssh-copy-id -o StrictHostKeyChecking=no root@192.168.2.222
      echo =====================172.16.1.$ip fenfa end===========================
      echo &quot;&quot;
    done
</pre></div>
</div>
</div>
<div class="section" id="ansible">
<h1><a class="toc-backref" href="#id11"><span class="section-number">2. </span>ansible安装</a><a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h1>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">ansible</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h1><a class="toc-backref" href="#id12"><span class="section-number">3. </span>ansible命令使用</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>hosts配置主机清单</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">hosts</span>
<span class="p">[</span><span class="n">webserver</span><span class="p">]</span>          <span class="c1"># 分组</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span><span class="p">:</span><span class="mi">222</span>    <span class="c1"># 非22端口加端口号</span>

<span class="p">[</span><span class="n">dbserver</span><span class="p">]</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.12</span>

<span class="p">[</span><span class="n">appserver</span><span class="p">]</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>输入密码执行ping测试</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span> <span class="o">-</span><span class="n">m</span> <span class="n">ping</span> <span class="o">-</span><span class="n">k</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">ping</span> <span class="o">-</span><span class="n">k</span>   <span class="c1"># all所有主机</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">command</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;ls /root&#39;</span> <span class="o">-</span><span class="n">u</span> <span class="n">wang</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">K</span>    <span class="c1"># 使用wang远程sudo root执行命令</span>
</pre></div>
</div>
<p>取消key的检查并记录日志</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">ansible</span><span class="o">.</span><span class="n">cfg</span>
<span class="n">host_key_checking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 取消注释</span>
<span class="n">log_path</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">ansible</span><span class="o">.</span><span class="n">log</span>  <span class="c1"># 取消注释</span>
</pre></div>
</div>
<p>查看被管理的所有主机</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">hosts</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">inventory</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">prod_hosts</span>  <span class="o">--</span><span class="n">graph</span>
</pre></div>
</div>
<p>免密钥验证</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">t</span> <span class="n">rsa</span> <span class="c1"># 一路回车</span>

<span class="n">ssh</span><span class="o">-</span><span class="n">copy</span><span class="o">-</span><span class="nb">id</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span>
</pre></div>
</div>
<p>ansible的host-pattern</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>逻辑与:在webserver组并且在dbserver组中的主机
ansible &quot;webserver:&amp;dbserver&quot; -m ping

逻辑非:在webserver组，但不在dbserver组中的主机
ansible &#39;webserver:!dbserver&#39; -m ping # 注意单引号

综合逻辑:即在webserver又在dbserver并且在appserver但是不在ftpserver中的主机
ansible &#39;webserver:dbserver:&amp;appserver:!ftpserver&#39; -m ping
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h1><a class="toc-backref" href="#id13"><span class="section-number">4. </span>ansible常用模块详解</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h1>
<div class="section" id="lineinfile">
<h2><a class="toc-backref" href="#id14"><span class="section-number">4.1. </span>lineinfile文本修改模块</a><a class="headerlink" href="#lineinfile" title="Permalink to this headline">¶</a></h2>
<p>详情请参考：<a class="reference external" href="https://www.cnblogs.com/jackchen001/p/6710233.html">https://www.cnblogs.com/jackchen001/p/6710233.html</a></p>
<p><strong>在匹配的内容前或后增加一行</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@master</span> <span class="n">test</span><span class="p">]</span><span class="c1"># cat http.conf</span>
<span class="c1">#Listen 12.34.56.78:80</span>
<span class="c1">#Listen 80</span>
<span class="c1">#Port</span>
</pre></div>
</div>
<p>insertbefore匹配内容在前面添加</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">httpd</span><span class="o">.</span><span class="n">conf</span> <span class="n">modify</span> <span class="mi">8080</span>
  <span class="n">lineinfile</span><span class="p">:</span>
     <span class="n">dest</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">playbook</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">http</span><span class="o">.</span><span class="n">conf</span>
     <span class="n">regexp</span><span class="p">:</span> <span class="s1">&#39;^Listen&#39;</span>
     <span class="n">insertbefore</span><span class="p">:</span> <span class="s1">&#39;^#Port&#39;</span>
     <span class="n">line</span><span class="p">:</span> <span class="s1">&#39;Listen 8080&#39;</span>
  <span class="n">tags</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">http8080</span>
</pre></div>
</div>
<p>验证</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@master</span> <span class="n">test</span><span class="p">]</span><span class="c1"># cat http.conf</span>
<span class="c1">#Listen 12.34.56.78:80</span>
<span class="c1">#Listen 80</span>
<span class="n">Listen</span> <span class="mi">8080</span>
<span class="c1">#Port</span>
</pre></div>
</div>
<p>insertafter匹配内容在后面添加</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">httpd</span><span class="o">.</span><span class="n">conf</span> <span class="n">modify</span> <span class="mi">8080</span>
      <span class="n">lineinfile</span><span class="p">:</span>
         <span class="n">dest</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">playbook</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">http</span><span class="o">.</span><span class="n">conf</span>
         <span class="n">regexp</span><span class="p">:</span> <span class="s1">&#39;^Listen&#39;</span>
         <span class="n">insertafter</span><span class="p">:</span> <span class="s1">&#39;^#Port&#39;</span>
         <span class="n">line</span><span class="p">:</span> <span class="s1">&#39;Listen 8080&#39;</span>
      <span class="n">tags</span><span class="p">:</span>
       <span class="o">-</span> <span class="n">http8080</span>
</pre></div>
</div>
<p>验证</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@master</span> <span class="n">test</span><span class="p">]</span><span class="c1"># cat http.conf</span>
<span class="c1">#Listen 12.34.56.78:80</span>
<span class="c1">#Listen 80</span>
<span class="c1">#Port</span>
<span class="n">Listen</span> <span class="mi">8080</span>
</pre></div>
</div>
<p>实例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">4.159</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
  <span class="nb">vars</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">app_name</span><span class="p">:</span> <span class="n">ypsx</span><span class="o">-</span><span class="n">demo</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">updata</span> <span class="n">filebeat</span><span class="o">.</span><span class="n">conf</span>
      <span class="n">lineinfile</span><span class="p">:</span>
        <span class="n">dest</span><span class="p">:</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ypsx</span><span class="o">.</span><span class="n">yml</span>
        <span class="n">insertafter</span><span class="p">:</span> <span class="s1">&#39;paths:&#39;</span>
        <span class="n">line</span><span class="p">:</span> <span class="s1">&#39;    - /home/admin/logs/{{ 应用变量名 }}.log&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="command">
<h2><a class="toc-backref" href="#id15"><span class="section-number">4.2. </span>command模块</a><a class="headerlink" href="#command" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">commmand</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;service vsftpd start&#39;</span> <span class="c1"># 默认模块，不支持$HOSTNAME &lt; &gt; |; &amp;等</span>
</pre></div>
</div>
</div>
<div class="section" id="shell">
<h2><a class="toc-backref" href="#id16"><span class="section-number">4.3. </span>shell模块</a><a class="headerlink" href="#shell" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">shell</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;hostname&quot;</span>  <span class="c1"># 支持管道符号,相当于shell执行命令</span>
</pre></div>
</div>
</div>
<div class="section" id="script">
<h2><a class="toc-backref" href="#id17"><span class="section-number">4.4. </span>script模块</a><a class="headerlink" href="#script" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">script</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;/root/ansible/host.sh&#39;</span>  <span class="c1"># 在ansible创建脚本，本地执行到远程机器</span>
</pre></div>
</div>
</div>
<div class="section" id="copy">
<h2><a class="toc-backref" href="#id18"><span class="section-number">4.5. </span>copy模块</a><a class="headerlink" href="#copy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">copy</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;src=/root/ansible/selinux dest=/etc/selinux/config backup=yes mode=644 ower=root&#39;</span> <span class="c1"># 复制文件并备份源文件,修改权限，属主</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">copy</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;content=&quot;hello&quot; dest=/etc/test.txt backup=yes mode=644 ower=root&#39;</span>
<span class="c1"># 自己写文件内容发送到服务器</span>
</pre></div>
</div>
</div>
<div class="section" id="fetch">
<h2><a class="toc-backref" href="#id19"><span class="section-number">4.6. </span>fetch模块</a><a class="headerlink" href="#fetch" title="Permalink to this headline">¶</a></h2>
<p>从客户端取文件至服务器端，copy相反,必须是单个文件</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">fetch</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;src=/var/log/messages dest=/data&#39;</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@master</span> <span class="o">.</span><span class="n">ssh</span><span class="p">]</span><span class="c1"># ll /data</span>
<span class="n">总用量</span> <span class="mi">0</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">3</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">17</span> <span class="mi">10</span><span class="n">月</span> <span class="mi">18</span> <span class="mi">06</span><span class="p">:</span><span class="mi">51</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">3</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">17</span> <span class="mi">10</span><span class="n">月</span> <span class="mi">18</span> <span class="mi">06</span><span class="p">:</span><span class="mi">51</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">11.12</span>
</pre></div>
</div>
</div>
<div class="section" id="file">
<h2><a class="toc-backref" href="#id20"><span class="section-number">4.7. </span>file模块</a><a class="headerlink" href="#file" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">file</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;path=/tmp/f3 state=touch&#39;</span>  <span class="c1"># 新建文件</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">file</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;path=/tmp/f3 state=absent&#39;</span>  <span class="c1"># 删除</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">file</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;path=/data/dir1 state=directory&#39;</span> <span class="c1"># 新建文件夹</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">file</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;path=/data/dir1 state=absent&#39;</span> <span class="c1"># 删除</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">file</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;path=/etc/fstab dest=/tmp/fstab.link state=link&#39;</span> <span class="c1"># 创建软连接</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">file</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;dest=/tmp/fstab.link state=absent&#39;</span> <span class="c1"># 创建软连接</span>
</pre></div>
</div>
</div>
<div class="section" id="hostname">
<h2><a class="toc-backref" href="#id21"><span class="section-number">4.8. </span>hostname模块</a><a class="headerlink" href="#hostname" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span> <span class="o">-</span><span class="n">m</span> <span class="n">hostname</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=node1&#39;</span> <span class="c1"># 修改主机名</span>
</pre></div>
</div>
</div>
<div class="section" id="cron">
<h2><a class="toc-backref" href="#id22"><span class="section-number">4.9. </span>cron模块</a><a class="headerlink" href="#cron" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span> <span class="o">-</span><span class="n">m</span> <span class="n">cron</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;minute=* hour=0 day=* month=* weekday=1,3,5 job=&quot;/usr/wall FBI warning&quot;  name=warningcron&#39;</span>  <span class="c1"># 设置定时任务</span>
<span class="n">ansible</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span> <span class="o">-</span><span class="n">m</span> <span class="n">cron</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;disabled=true job=&quot;/usr/wall FBI warning&quot;  name=warningcron&#39;</span>  <span class="c1"># 注释定时任务</span>
</pre></div>
</div>
</div>
<div class="section" id="yum">
<h2><a class="toc-backref" href="#id23"><span class="section-number">4.10. </span>yum模块</a><a class="headerlink" href="#yum" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">yum</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=vsftpd&#39;</span>  <span class="c1"># 安装，多个使用,分割</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">yum</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=vsftpd state=absent&#39;</span>  <span class="c1"># 卸载</span>
</pre></div>
</div>
</div>
<div class="section" id="service">
<h2><a class="toc-backref" href="#id24"><span class="section-number">4.11. </span>service模块</a><a class="headerlink" href="#service" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=vsftpd state=started enabled=yes&#39;</span> <span class="c1"># 启动并且开机自启动</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=vsftpd state=restarted&#39;</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=vsftpd state=stopped&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="user">
<h2><a class="toc-backref" href="#id25"><span class="section-number">4.12. </span>user模块</a><a class="headerlink" href="#user" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">user</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=nginx shell=/sbin/nologin system=yes home=/home/nginx&#39;</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">user</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=nginx state=absent remove=yes&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="ansible-galaxy">
<h2><a class="toc-backref" href="#id26"><span class="section-number">4.13. </span>ansible-galaxy</a><a class="headerlink" href="#ansible-galaxy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">galaxy</span> <span class="n">install</span> <span class="n">geerlingguy</span><span class="o">.</span><span class="n">nginx</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">galaxy</span> <span class="nb">list</span> <span class="n">geerlingguy</span><span class="o">.</span><span class="n">nginx</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">galaxy</span> <span class="n">remove</span> <span class="n">geerlingguy</span><span class="o">.</span><span class="n">nginx</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id27"><span class="section-number">4.14. </span>对文件进行加密</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">encrype</span> <span class="n">hello</span><span class="o">.</span><span class="n">yml</span>  <span class="c1"># 输入口令</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">decrypt</span> <span class="n">hello</span><span class="o">.</span><span class="n">yml</span>  <span class="c1"># 输入口令</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">rekey</span> <span class="n">hello</span><span class="o">.</span><span class="n">yml</span>    <span class="c1"># 修改口令</span>
</pre></div>
</div>
</div>
<div class="section" id="ansible-console">
<h2><a class="toc-backref" href="#id28"><span class="section-number">4.15. </span>ansible-console</a><a class="headerlink" href="#ansible-console" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>root@webserver (1)[f:5]$
[root@master ~]# ansible-console
Welcome to the ansible console.
Type help or ? to list commands.

root@all (2)[f:5]$ cd webserver
root@webserver (1)[f:5]$ forks 10
root@webserver (1)[f:10]$ command hostname
192.168.11.11 | CHANGED | rc=0 &gt;&gt;
node1
</pre></div>
</div>
</div>
</div>
<div class="section" id="yaml">
<h1><a class="toc-backref" href="#id29"><span class="section-number">5. </span>YAML语法简介</a><a class="headerlink" href="#yaml" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="ansible-playbook">
<h1><a class="toc-backref" href="#id30"><span class="section-number">6. </span>ansible playbook基础</a><a class="headerlink" href="#ansible-playbook" title="Permalink to this headline">¶</a></h1>
<p>简单事列</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webserver</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>

  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">hello</span>
      <span class="n">command</span><span class="p">:</span> <span class="n">hostname</span>
</pre></div>
</div>
<div class="section" id="playbook-tags-handlers">
<h2><a class="toc-backref" href="#id31"><span class="section-number">6.1. </span>playbook变量，tags，handlers使用</a><a class="headerlink" href="#playbook-tags-handlers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="handlersnotifyhttpd">
<h3><a class="toc-backref" href="#id32">handlers配合notify实现httpd配置发生变化自动重载配置</a><a class="headerlink" href="#handlersnotifyhttpd" title="Permalink to this headline">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">webserver</span>
  <span class="nt">remote_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>

  <span class="nt">tasks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">install package</span>
      <span class="nt">yum</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">name=httpd</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">copy conf file</span>
      <span class="nt">copy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">src=files/httpd.conf dest=/etc/httpd/conf/ backup=yes</span>
      <span class="nt">notify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restart service</span>   <span class="c1"># 配置文件修改之后就重启</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">start service</span>
      <span class="nt">service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">name=httpd state=started enabled=yes</span>

  <span class="nt">handlers</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restart service</span>
      <span class="nt">service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">name=httpd state=restarted</span>  <span class="c1"># 对应上面的notify</span>
</pre></div>
</div>
</div>
<div class="section" id="tags">
<h3><a class="toc-backref" href="#id33">tags单独执行某个标签</a><a class="headerlink" href="#tags" title="Permalink to this headline">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="nt">hosts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">webserver</span>
  <span class="nt">remote_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>

  <span class="nt">tasks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">install package</span>
      <span class="nt">yum</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">name=httpd</span>
            <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">inhttpd</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">copy conf file</span>
      <span class="nt">copy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">src=files/httpd.conf dest=/etc/httpd/conf/ backup=yes</span>
      <span class="nt">notify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restart service</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">start service</span>
      <span class="nt">service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">name=httpd state=started enabled=yes</span>
      <span class="nt">tags</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rshttpd</span>

  <span class="nt">handlers</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restart service</span>
      <span class="nt">service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">name=httpd state=restarted</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook -t rshttpd httpd.yml</span> <span class="c1"># 单独执行某个标签</span>
<span class="l l-Scalar l-Scalar-Plain">ansible-playbook -t rshttpd,inhttpd httpd.yml</span> <span class="c1"># 执行多个标签</span>
<span class="l l-Scalar l-Scalar-Plain">ansible-playbook -t rshttpd httpd.yml</span> <span class="c1"># 多个tags可以共用一个标签</span>
<span class="l l-Scalar l-Scalar-Plain">ansible-playbook httpd.yml --list-tags</span> <span class="c1"># 查看标签信息</span>
</pre></div>
</div>
</div>
<div class="section" id="playbook">
<h3><a class="toc-backref" href="#id34">playbook变量指定单个变量</a><a class="headerlink" href="#playbook" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webserver</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>

  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">package</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">pkname</span> <span class="p">}}</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">start</span> <span class="n">service</span>
      <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">pkname</span> <span class="p">}}</span> <span class="n">state</span><span class="o">=</span><span class="n">started</span> <span class="n">enabled</span><span class="o">=</span><span class="n">yes</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;pkname=vsftpd&#39;</span> <span class="n">package</span><span class="o">.</span><span class="n">yml</span> <span class="c1"># 指定变量</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id35">playbook变量指定多个变量</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webserver</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>

  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">package</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">pkname1</span> <span class="p">}}</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">package</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">pkname2</span> <span class="p">}}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;pkname1=vsftpd pkname2=redis&#39;</span> <span class="n">package</span><span class="o">.</span><span class="n">yml</span> <span class="c1"># 指定变量</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id36">声明变量</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webserver</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
  <span class="nb">vars</span><span class="p">:</span>
     <span class="o">-</span> <span class="n">pkname1</span><span class="p">:</span> <span class="n">httpd</span>
     <span class="o">-</span> <span class="n">pkname2</span><span class="p">:</span> <span class="n">redis</span>

  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">package</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">pkname1</span> <span class="p">}}</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">package</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">pkname2</span> <span class="p">}}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">package</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</div>
<div class="section" id="etc-ansible-hosts">
<h3><a class="toc-backref" href="#id37">在/etc/ansible/hosts 中定义单个变量</a><a class="headerlink" href="#etc-ansible-hosts" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">dbserver</span><span class="p">]</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.12</span> <span class="n">http_port</span><span class="o">=</span><span class="mi">81</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span> <span class="n">http_port</span><span class="o">=</span><span class="mi">82</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">dbserver</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>

  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="nb">set</span> <span class="n">hostname</span>
      <span class="n">hostname</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">blsnt</span><span class="p">{{</span> <span class="n">http_port</span> <span class="p">}}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">host</span><span class="o">.</span><span class="n">yml</span>
<span class="n">ansible</span> <span class="n">dbserver</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;hostname&#39;</span>  <span class="c1"># 已经修改</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.12</span> <span class="o">|</span> <span class="n">CHANGED</span> <span class="o">|</span> <span class="n">rc</span><span class="o">=</span><span class="mi">0</span> <span class="o">&gt;&gt;</span>
<span class="n">blsnt81</span>

<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span> <span class="o">|</span> <span class="n">CHANGED</span> <span class="o">|</span> <span class="n">rc</span><span class="o">=</span><span class="mi">0</span> <span class="o">&gt;&gt;</span>
<span class="n">blsnt82</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id38">在/etc/ansible/hosts 中定义组变量</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">dbserver</span><span class="p">:</span><span class="nb">vars</span><span class="p">]</span>
<span class="n">nodename</span><span class="o">=</span><span class="n">www</span>
<span class="n">domainname</span><span class="o">=</span><span class="n">blsnt</span>

<span class="p">[</span><span class="n">dbserver</span><span class="p">]</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.12</span> <span class="n">http_port</span><span class="o">=</span><span class="mi">81</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span> <span class="n">http_port</span><span class="o">=</span><span class="mi">82</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">dbserver</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>

  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="nb">set</span> <span class="n">hostname</span>
      <span class="n">hostname</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">nodename</span> <span class="p">}}{{</span> <span class="n">http_port</span> <span class="p">}}</span><span class="o">.</span><span class="p">{{</span> <span class="n">domainname</span> <span class="p">}}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">host</span><span class="o">.</span><span class="n">yml</span>
<span class="n">ansible</span> <span class="n">dbserver</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;hostname&#39;</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.12</span> <span class="o">|</span> <span class="n">CHANGED</span> <span class="o">|</span> <span class="n">rc</span><span class="o">=</span><span class="mi">0</span> <span class="o">&gt;&gt;</span>
<span class="n">www81</span><span class="o">.</span><span class="n">blsnt</span>

<span class="mf">192.168</span><span class="o">.</span><span class="mf">11.11</span> <span class="o">|</span> <span class="n">CHANGED</span> <span class="o">|</span> <span class="n">rc</span><span class="o">=</span><span class="mi">0</span> <span class="o">&gt;&gt;</span>
<span class="n">www82</span><span class="o">.</span><span class="n">blsnt</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id39">通过命令行执行变量优先级最高</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">e</span> <span class="n">varname</span><span class="o">=</span><span class="n">value</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id40">在playbook中定义</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>vars:
  - var1: value1
  - var2: value2
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id41">在独立变量yaml文件中定义</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>cat vars.yml
var1: httpd
var2: nginx
</pre></div>
</div>
<p>调用</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>cat var.yml
- hosts: web
  remote_user: root
  vars_files:
    - vars.yml
  tasks:
    - name: create httpd log
      file: name=/app/{{ var1 }}.log state=touch
    - name: create nginx log
      file: name=/app/{{ var2 }}.log state=touch
</pre></div>
</div>
</div>
</div>
<div class="section" id="playbooktemplates">
<h2><a class="toc-backref" href="#id42"><span class="section-number">6.2. </span>playbook模板templates</a><a class="headerlink" href="#playbooktemplates" title="Permalink to this headline">¶</a></h2>
<p>通过ansible内置的变量自动设置nginx的worker数量</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>ansible webserver -m setup|grep &quot;cpu&quot;
ansible webserver -m setup -a &#39;filter=ansible_os_family&#39;
</pre></div>
</div>
<p>将nginx模板配置文件worker数量修改为变量，自动根据机器核数生成</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>worker_processes {{ ansible_processor_vcpus }}
</pre></div>
</div>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>- hosts: webserver
  remote_user: root

  tasks:
    - name: install package
      yum: name=nginx
    - name: copy templeate
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
    - name: start service
      service: name=nginx state=started enabled=yes
</pre></div>
</div>
</div>
<div class="section" id="playbookewhen">
<h2><a class="toc-backref" href="#id43"><span class="section-number">6.3. </span>playbooke条件判断when</a><a class="headerlink" href="#playbookewhen" title="Permalink to this headline">¶</a></h2>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>- hosts: webserver
  remote_user: root

  tasks:
    - name: install package
      yum: name=nginx
    - name: copy templeate for centos7
      template: src=nginx.conf7.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version == &quot;7&quot;
    - name: copy templeate for centos6
      template: nginx.conf6.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version == &quot;6&quot;
    - name: start service
      service: name=nginx state=started enabled=yes
</pre></div>
</div>
</div>
</div>
<div class="section" id="playbookwith-items">
<h1><a class="toc-backref" href="#id44"><span class="section-number">7. </span>playbook字典with_items</a><a class="headerlink" href="#playbookwith-items" title="Permalink to this headline">¶</a></h1>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>- hosts: webserver
  remote_user: root

  tasks:
    - name: create some file
      file: name=/data/{{ item }} state=touch
      when: ansible_distribution_major_version == &quot;7&quot;
      with_items:
        - file1
        - file2
        - file3
    - name: install some packages
      yum: name={{ item }}
      with_items:
        - httpd
        - vsftpd
        - sl
</pre></div>
</div>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>- hosts: webserver
  remote_user: root

  tasks:
    - name: create some groups
      group: name={{ item }}
      when: ansible_distribution_major_version == &quot;7&quot;
      with_items:
        - g1
        - g2
        - g3
    - name: create some users
      user: name={{ item.name }} group={{ item.group }}
      with_items:
        - { name: &#39;user1&#39;, group: &#39;g1&#39; }
        - { name: &#39;user2&#39;, group: &#39;g2&#39; }
        - { name: &#39;user3&#39;, group: &#39;g3&#39; }
</pre></div>
</div>
</div>
<div class="section" id="playbooktemplate-for-if">
<h1><a class="toc-backref" href="#id45"><span class="section-number">8. </span>playbook中template for if</a><a class="headerlink" href="#playbooktemplate-for-if" title="Permalink to this headline">¶</a></h1>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>- hosts: webserver
  remote_user: root
  vars:
    ports:
      - 81
      - 82
      - 83
  tasks:
    - name: copy conf
      template: src=for1.conf.j2 dest=/data/for1.conf
</pre></div>
</div>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>vim for1.conf.j2
{% for port in ports %}
server{
    listen {{ port }}
}
{% end %}
</pre></div>
</div>
<p>高级用法</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>- hosts: webserver
  remote_user: root
  vars:
    ports:
      - web1:
              port: 81
              name: web1.blsnt.com
              rootdir: /data/werb1
            - web2:
              port: 82
              name: web2.blsnt.com
              rootdir: /data/web2
            - web3:
              port: 83
              name: web3.blsnt.com
              rootdir: /data/web3
  tasks:
    - name: copy conf
      template: src=for1.conf.j2 dest=/data/for1.conf
</pre></div>
</div>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>{% for p in ports %}
server{
        listen {{ p.port }}
        servername {{ p.name }}
        documentroot{{ p.rootdir }}
}
{% end %}
</pre></div>
</div>
<p>If 判断</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>- hosts: webserver
  remote_user: root
  vars:
    ports:
      - web1:
              port: 81
              #name: web1.blsnt.com
              rootdir: /data/werb1
            - web2:
              port: 82
              name: web2.blsnt.com
              rootdir: /data/web2
            - web3:
              port: 83
              name: web3.blsnt.com
              rootdir: /data/web3
  tasks:
    - name: copy conf
      template: src=for1.conf.j2 dest=/data/for1.conf
</pre></div>
</div>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>{% for p in ports %}
server{
        listen {{ p.port }}
{% if p.name is defined $%}
        servername {{ p.name }}
{% endif %}
        documentroot{{ p.rootdir }}
}
{% end %}
</pre></div>
</div>
</div>
<div class="section" id="ansible-roles">
<h1><a class="toc-backref" href="#id46"><span class="section-number">9. </span>ansible Roles</a><a class="headerlink" href="#ansible-roles" title="Permalink to this headline">¶</a></h1>
<p>目录规范</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 推荐路径/etc/ansible</span>
<span class="n">roles</span><span class="o">/</span>
  <span class="n">nginx</span><span class="o">/</span>
        <span class="n">file</span>
    <span class="n">templates</span>
    <span class="n">tasks</span>
    <span class="n">handlers</span>
    <span class="nb">vars</span>
</pre></div>
</div>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>cat /etc/ansible/roles/nginx/tasks/group.yml
- name: create group
  group: name=nginx git=80

cat /etc/ansible/roles/nginx/tasks/user.yml
- name: create user
  user: name=nginx uid=80 group=nginx system=yes shell=/sbin/nologin

cat /etc/ansible/roles/nginx/tasks/yum.yml
- name: install package
  yum: name=nginx

cat /etc/ansible/roles/nginx/tasks/start.yml
- name: start service
  service: name=nginx state=started enabled=yes

cat /etc/ansible/roles/nginx/tasks/restart.yml
- name: restart service
  service: name=nginx state=restarted

cat /etc/ansible/roles/nginx/tasks/templ.yml
- name: copy conf
  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf

cat /etc/ansible/roles/nginx/tasks/main.yml
- include: group.yml
- include: user.yml
- include: yum.yml
- include: templ.yml
- include: start.yml

cat /etc/ansible/nginx_roles.yml
- hosts: webserver
  remote_user: root
  roles:
    - role: nginx

# 需要定义好模板文件，我这里就没有定义了
ansible-playbook nginx_roles.yml
</pre></div>
</div>
<p>同时调用角色</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>- hosts: webserver
 remote_user: root
 roles:
   - role: httpd
   - rele: redis
</pre></div>
</div>
<p>角色之间任务调用</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span> cat /etc/ansible/roles/nginx/tasks/main.yml
- include: group.yml
- include: user.yml
- include: yum.yml
- include: templ.yml
- include: start.yml
- include: roles/httpd/tasks/copyfile.yml
</pre></div>
</div>
<p>标签选择</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>cat /etc/ansible/some.role.yml
- hosts: webserver
  remote_user: root
  roles:
    - { role: httpd, tags: [&#39;web&#39;:&#39;httpd&#39;] }
    - { role: nginx, tags: [&#39;web&#39;:&#39;nginx&#39;] }

ansible-playbook -t web some_role.yml
</pre></div>
</div>
<p>标签选择加判断</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>- hosts: all
  remote_user: root
  roles:
    - { role: httpd, tags: [&#39;web&#39;:&#39;httpd&#39;] }
    - { role: nginx, tags: [&#39;web&#39;:&#39;nginx&#39;],when: ansible_distribution_major_version == &quot;7&quot; }
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">include</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">project</span><span class="p">:</span> <span class="s2">&quot;arch-foundation/cicd&quot;</span>
    <span class="n">ref</span><span class="p">:</span> <span class="n">test</span>
    <span class="n">file</span><span class="p">:</span> <span class="s2">&quot;/templates/Maven.gitlab-ci.yml&quot;</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Ansible" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, 小义同学

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>