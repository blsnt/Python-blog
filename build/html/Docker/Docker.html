

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1. } &mdash; BLSNT BLOG 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Docker基础与使用" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> BLSNT BLOG
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Python/index.html">Python入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Python/index.html#django">django框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Linux/index.html">Linux基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../golang/index.html">golang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ELK/index.html">ELK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Ansible/index.html">Ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SaltStack/index.html">SaltStack</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Docker基础与使用</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">1. }</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BLSNT BLOG</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Docker基础与使用</a> &raquo;</li>
        
      <li><span class="section-number">1. </span>}</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Docker/Docker.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <ul>
<li><p>[Docker是什么？](#docker%E6%98%AF%E4%BB%80%E4%B9%88)</p></li>
<li><p>[为什么要使用 Docker?](#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8-docker)</p></li>
<li><p>[为什么要使用 Docker？](#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8-docker)
* [更高效的利用系统资源](#%E6%9B%B4%E9%AB%98%E6%95%88%E7%9A%84%E5%88%A9%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90)
* [更快速的启动时间](#%E6%9B%B4%E5%BF%AB%E9%80%9F%E7%9A%84%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%B4)
* [一致的运行环境](#%E4%B8%80%E8%87%B4%E7%9A%84%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83)
* [持续交付和部署](#%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E5%92%8C%E9%83%A8%E7%BD%B2)
* [更轻松的迁移](#%E6%9B%B4%E8%BD%BB%E6%9D%BE%E7%9A%84%E8%BF%81%E7%A7%BB)
* [更轻松的维护和扩展](#%E6%9B%B4%E8%BD%BB%E6%9D%BE%E7%9A%84%E7%BB%B4%E6%8A%A4%E5%92%8C%E6%89%A9%E5%B1%95)
* [对比传统虚拟机总结](#%E5%AF%B9%E6%AF%94%E4%BC%A0%E7%BB%9F%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%80%BB%E7%BB%93)</p></li>
<li><p>[<a href="#id1"><span class="problematic" id="id2">**</span></a>CentOS7.x**安装Docker](#centos7x%E5%AE%89%E8%A3%85docker)</p></li>
<li><p>[镜像管理](#%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86)
* [镜像是什么？](#%E9%95%9C%E5%83%8F%E6%98%AF%E4%BB%80%E4%B9%88)
* [<strong>镜像从哪里来?</strong>](#%E9%95%9C%E5%83%8F%E4%BB%8E%E5%93%AA%E9%87%8C%E6%9D%A5)
* [<strong>镜像与容器联系</strong>](#%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8%E8%81%94%E7%B3%BB)
* [<strong>管理镜像常用命令</strong>](#%E7%AE%A1%E7%90%86%E9%95%9C%E5%83%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4)</p></li>
<li><p>[容器管理](#%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86)
* [创建容器常用选项](#%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9)
* [容器资源限制](#%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6)
* [管理容器常用命令](#%E7%AE%A1%E7%90%86%E5%AE%B9%E5%99%A8%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4)</p></li>
<li><p>[管理应用程序数据](#%E7%AE%A1%E7%90%86%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%95%B0%E6%8D%AE)
* [将数据从宿主机挂载到容器中的三种方式](#%E5%B0%86%E6%95%B0%E6%8D%AE%E4%BB%8E%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%8C%82%E8%BD%BD%E5%88%B0%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F)</p></li>
<li><p>[Dockerfile](#dockerfile)
* [Dockerfile指令](#dockerfile%E6%8C%87%E4%BB%A4)
* [构建业务基础镜像](#%E6%9E%84%E5%BB%BA%E4%B8%9A%E5%8A%A1%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F)</p>
<blockquote>
<div><ul class="simple">
<li><p>[构建Nginx基础镜像](#%E6%9E%84%E5%BB%BAnginx%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F)</p></li>
<li><p>[构建PHP基础镜像](#%E6%9E%84%E5%BB%BAphp%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F)</p></li>
<li><p>[构建Tomcat基础镜像](#%E6%9E%84%E5%BB%BAtomcat%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F)</p></li>
<li><p>[快速部署LNMP网站平台](#%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2lnmp%E7%BD%91%E7%AB%99%E5%B9%B3%E5%8F%B0)</p></li>
</ul>
</div></blockquote>
</li>
<li><p>[企业级镜像仓库Harbor](#%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93harbor)
* [harbor概述](#harbor%E6%A6%82%E8%BF%B0)
* [Harbor部署](#harbor%E9%83%A8%E7%BD%B2)
* [基本使用](#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8)</p></li>
<li><p>[<strong>Jenkins与Docker的自动化CI/CD流水线实战</strong>](#jenkins%E4%B8%8Edocker%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96cicd%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%AE%9E%E6%88%98)</p></li>
</ul>
<p>## Docker是什么？</p>
<p>Docker 最初是 dotCloud 公司创始人 Solomon Hykes 在法国期间发起的一个公司内部项目，它是基于 dotCloud 公司多年云服务技术的一次革新，并于 [2013 年 3 月以 Apache 2.0 授权协议开源](<a class="reference external" href="https://en.wikipedia.org/wiki/Docker_(software">https://en.wikipedia.org/wiki/Docker_(software</a>))，主要项目代码在 [GitHub](<a class="reference external" href="https://github.com/moby/moby">https://github.com/moby/moby</a>) 上进行维护。Docker 项目后来还加入了 Linux 基金会，并成立推动 [开放容器联盟（OCI）](<a class="reference external" href="https://www.opencontainers.org/">https://www.opencontainers.org/</a>)。</p>
<p>Docker 自开源后受到广泛的关注和讨论，至今其 [GitHub 项目](<a class="reference external" href="https://github.com/moby/moby">https://github.com/moby/moby</a>) 已经超过 5 万 2 千个星标和一万多个 fork。甚至由于 Docker 项目的火爆，在 2013 年底，[dotCloud 公司决定改名为 Docker](<a class="reference external" href="https://blog.docker.com/2013/10/dotcloud-is-becoming-docker-inc/">https://blog.docker.com/2013/10/dotcloud-is-becoming-docker-inc/</a>)。Docker 最初是在 Ubuntu 12.04 上开发实现的；Red Hat 则从 RHEL 6.5 开始对 Docker 进行支持；Google 也在其 PaaS 产品中广泛应用 Docker。</p>
<p>Docker 使用 Google 公司推出的 [Go 语言](<a class="reference external" href="https://golang.org/">https://golang.org/</a>) 进行开发实现，基于 Linux 内核的 [cgroup](<a class="reference external" href="https://zh.wikipedia.org/wiki/Cgroups">https://zh.wikipedia.org/wiki/Cgroups</a>)，[namespace](<a class="reference external" href="https://en.wikipedia.org/wiki/Linux_namespaces">https://en.wikipedia.org/wiki/Linux_namespaces</a>)，以及[AUFS](<a class="reference external" href="https://en.wikipedia.org/wiki/Aufs">https://en.wikipedia.org/wiki/Aufs</a>) 类的 [Union FS](<a class="reference external" href="https://en.wikipedia.org/wiki/Union_mount">https://en.wikipedia.org/wiki/Union_mount</a>) 等技术，对进程进行封装隔离，属于 [操作系统层面的虚拟化技术](<a class="reference external" href="https://en.wikipedia.org/wiki/Operating-system-level_virtualization">https://en.wikipedia.org/wiki/Operating-system-level_virtualization</a>)。由于隔离的进程独立于宿主和其它的隔离的进程，因此也称其为容器。最初实现是基于 [LXC](<a class="reference external" href="https://linuxcontainers.org/lxc/introduction/">https://linuxcontainers.org/lxc/introduction/</a>)，从 0.7 版本以后开始去除 LXC，转而使用自行开发的 [libcontainer](<a class="reference external" href="https://github.com/docker/libcontainer">https://github.com/docker/libcontainer</a>)，从 1.11 开始，则进一步演进为使用 [runC](<a class="reference external" href="https://github.com/opencontainers/runc">https://github.com/opencontainers/runc</a>) 和 [containerd](<a class="reference external" href="https://github.com/containerd/containerd">https://github.com/containerd/containerd</a>)。</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726005246.png">http://images.dregs.top/images/20190726005246.png</a>)</p>
<p>&gt;`runc` 是一个 Linux 命令行工具，用于根据 [OCI容器运行时规范](<a class="reference external" href="https://github.com/opencontainers/runtime-spec">https://github.com/opencontainers/runtime-spec</a>) 创建和运行容器。
&gt;
&gt;`containerd` 是一个守护程序，它管理容器生命周期，提供了在一个节点上执行容器和管理镜像的最小功能集。</p>
<p>Docker 在容器的基础上，进行了进一步的封装，从文件系统、网络互联到进程隔离等等，极大的简化了容器的创建和维护。使得 Docker 技术比虚拟机技术更为轻便、快捷。</p>
<p>下面的图片比较了 Docker 和传统虚拟化方式的不同之处。传统虚拟机技术是虚拟出一套硬件后，在其上运行一个完整操作系统，在该系统上再运行所需应用进程；而容器内的应用进程直接运行于宿主的内核，容器内没有自己的内核，而且也没有进行硬件虚拟。因此容器要比传统虚拟机更为轻便。</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726005426.png">http://images.dregs.top/images/20190726005426.png</a>)</p>
<p>​                                                                                                                                               <em>图 1.4.1.2 - 传统虚拟化</em></p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726005512.png">http://images.dregs.top/images/20190726005512.png</a>)</p>
<p>​                                                                                                                                               <em>图 1.4.1.3 - Docker</em></p>
<p>## 为什么要使用 Docker?</p>
<ul class="simple">
<li><p>更高效的利用系统资源</p></li>
<li><p>更快速的启动时间</p></li>
<li><p>一致的运行环境</p></li>
<li><p>持续交付和部署</p></li>
<li><p>更轻松的迁移</p></li>
<li><p>更轻松的维护和扩展</p></li>
<li><p>对比传统虚拟机总结</p></li>
</ul>
<ul class="simple">
<li><p>使用最广泛的开源容器引擎</p></li>
</ul>
<p>## 为什么要使用 Docker？</p>
<p>作为一种新兴的虚拟化方式，Docker 跟传统的虚拟化方式相比具有众多的优势。</p>
<p>### 更高效的利用系统资源</p>
<p>由于容器不需要进行硬件虚拟以及运行完整操作系统等额外开销，Docker 对系统资源的利用率更高。无论是应用执行速度、内存损耗或者文件存储速度，都要比传统虚拟机技术更高效。因此，相比虚拟机技术，一个相同配置的主机，往往可以运行更多数量的应用。</p>
<p>### 更快速的启动时间</p>
<p>传统的虚拟机技术启动应用服务往往需要数分钟，而 Docker 容器应用，由于直接运行于宿主内核，无需启动完整的操作系统，因此可以做到秒级、甚至毫秒级的启动时间。大大的节约了开发、测试、部署的时间。</p>
<p>### 一致的运行环境</p>
<p>开发过程中一个常见的问题是环境一致性问题。由于开发环境、测试环境、生产环境不一致，导致有些 bug 并未在开发过程中被发现。而 Docker 的镜像提供了除内核外完整的运行时环境，确保了应用运行环境一致性，从而不会再出现 <em>「这段代码在我机器上没问题啊」</em> 这类问题。</p>
<p>### 持续交付和部署</p>
<p>对开发和运维`DevOps`人员来说，最希望的就是一次创建或配置，可以在任意地方正常运行。</p>
<p>使用 Docker 可以通过定制应用镜像来实现持续集成、持续交付、部署。开发人员可以通过 <cite>Dockerfile</cite> 来进行镜像构建，并结合 <cite>持续集成(Continuous Integration)</cite> 系统进行集成测试，而运维人员则可以直接在生产环境中快速部署该镜像，甚至结合 <cite>持续部署(Continuous Delivery/Deployment)</cite> 系统进行自动部署。</p>
<p>而且使用 <cite>Dockerfile</cite> 使镜像构建透明化，不仅仅开发团队可以理解应用运行环境，也方便运维团队理解应用运行所需条件，帮助更好的生产环境中部署该镜像。</p>
<p>### 更轻松的迁移</p>
<p>由于 Docker 确保了执行环境的一致性，使得应用的迁移更加容易。Docker 可以在很多平台上运行，无论是物理机、虚拟机、公有云、私有云，甚至是笔记本，其运行结果是一致的。因此用户可以很轻易的将在一个平台上运行的应用，迁移到另一个平台上，而不用担心运行环境的变化导致应用无法正常运行的情况。</p>
<p>### 更轻松的维护和扩展</p>
<p>Docker 使用的分层存储以及镜像的技术，使得应用重复部分的复用更为容易，也使得应用的维护更新更加简单，基于基础镜像进一步扩展镜像也变得非常简单。此外，Docker 团队同各个开源项目团队一起维护了一大批高质量的 [官方镜像](<a class="reference external" href="https://hub.docker.com/search/?type=image&amp;image_filter=official">https://hub.docker.com/search/?type=image&amp;image_filter=official</a>)，既可以直接在生产环境使用，又可以作为基础进一步定制，大大的降低了应用服务的镜像制作成本。</p>
<p>### 对比传统虚拟机总结</p>
<div class="line-block">
<div class="line">特性       | 容器               | 虚拟机      |</div>
<div class="line">:——— | :—————– | :———- |</div>
<div class="line">启动       | 秒级               | 分钟级      |</div>
<div class="line">硬盘使用   | 一般为 <cite>MB</cite>        | 一般为 <cite>GB</cite> |</div>
<div class="line">性能       | 接近原生           | 弱于        |</div>
<div class="line">系统支持量 | 单机支持上千个容器 | 一般几十个  |</div>
</div>
<p>## <a href="#id3"><span class="problematic" id="id4">**</span></a>CentOS7.x**安装Docker</p>
<ul class="simple">
<li><p>系统环境</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;blsnt">root<span>&#64;</span>blsnt</a> ~]# cat /etc/redhat-release
CentOS Linux release 7.4.1708 (Core)
[<a class="reference external" href="mailto:root&#37;&#52;&#48;blsnt">root<span>&#64;</span>blsnt</a> ~]# uname -r
3.10.0-693.el7.x86_64
[<a class="reference external" href="mailto:root&#37;&#52;&#48;blsnt">root<span>&#64;</span>blsnt</a> ~]# systemctl status firewalld.service
● firewalld.service - firewalld - dynamic firewall daemon</p>
<blockquote>
<div><p>Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
Active: inactive (dead)</p>
<blockquote>
<div><p>Docs: man:firewalld(1)</p>
</div></blockquote>
</div></blockquote>
<p>Hint: Some lines were ellipsized, use -l to show in full.
[<a class="reference external" href="mailto:root&#37;&#52;&#48;blsnt">root<span>&#64;</span>blsnt</a> ~]# getenforce
Permissive
<a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">`</span></a></p>
<ul class="simple">
<li><p>安装依赖包</p></li>
</ul>
<blockquote>
<div><p><a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">`</span></a>shell</p>
</div></blockquote>
<dl class="simple">
<dt>yum install -y yum-utils device-mapper-persistent-data lvm2</dt><dd><p><a href="#id17"><span class="problematic" id="id18">``</span></a><a href="#id19"><span class="problematic" id="id20">`</span></a></p>
</dd>
</dl>
<ul class="simple">
<li><p>添加Docker软件包源</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">yum-config-manager</span> <span class="pre">\</span>
<span class="pre">--add-repo</span> <span class="pre">\</span>
<span class="pre">https://download.docker.com/linux/centos/docker-ce.repo</span>
<span class="pre">`</span></code></p>
<p>&gt; 如果网速比较慢可切换到阿里云或者清华源</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">#阿里云</span>
<span class="pre">yum-config-manager</span> <span class="pre">--add-repo</span> <span class="pre">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
<span class="pre">#清华</span>
<span class="pre">wget</span> <span class="pre">-O</span> <span class="pre">/etc/yum.repos.d/docker-ce.repo</span> <span class="pre">https://download.docker.com/linux/centos/docker-ce.repo</span>
<span class="pre">sed</span> <span class="pre">-i</span> <span class="pre">'s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+'</span> <span class="pre">/etc/yum.repos.d/docker-ce.repo</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>安装Docker CE</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">yum</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">docker-ce</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>启动Docker服务并设置开机启动</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">docker</span>
<span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">docker</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>docker镜像加速</p></li>
</ul>
<p><a href="#id21"><span class="problematic" id="id22">``</span></a><a href="#id23"><span class="problematic" id="id24">`</span></a>shell
curl -sSL <a class="reference external" href="https://get.daocloud.io/daotools/set_mirror.sh">https://get.daocloud.io/daotools/set_mirror.sh</a> | sh -s <a class="reference external" href="http://f1361db2.m.daocloud.io">http://f1361db2.m.daocloud.io</a></p>
<p>#重启docker
systemctl restart docker
<a href="#id25"><span class="problematic" id="id26">``</span></a><a href="#id27"><span class="problematic" id="id28">`</span></a></p>
<p>&gt; 官方文档：<a class="reference external" href="https://docs.docker.com/">https://docs.docker.com/</a></p>
<p>## Docker常用命令</p>
<p><code class="docutils literal notranslate"><span class="pre">`python</span>
<span class="pre">#</span> <span class="pre">查看版本信息</span>
<span class="pre">docker</span> <span class="pre">version</span>
<span class="pre">#</span> <span class="pre">查看命令帮助</span>
<span class="pre">docker</span> <span class="pre">--help</span>
<span class="pre">#</span> <span class="pre">列出镜像</span>
<span class="pre">docker</span> <span class="pre">images</span>
<span class="pre">docker</span> <span class="pre">images</span> <span class="pre">ls</span>
<span class="pre">#</span> <span class="pre">拉取镜像</span>
<span class="pre">docker</span> <span class="pre">pull</span> <span class="pre">centos:7</span>
<span class="pre">#</span> <span class="pre">查找镜像</span>
<span class="pre">docker</span> <span class="pre">search</span> <span class="pre">NAME</span>
<span class="pre">#</span> <span class="pre">删除镜像</span>
<span class="pre">docker</span> <span class="pre">rmi</span> <span class="pre">NAME</span>
<span class="pre">#</span> <span class="pre">查看容器</span>
<span class="pre">docker</span> <span class="pre">ps</span> <span class="pre">#</span> <span class="pre">查看正在运行的容器</span>
<span class="pre">docker</span> <span class="pre">ps</span> <span class="pre">-a</span> <span class="pre">#</span> <span class="pre">查看所有容器</span>
<span class="pre">docker</span> <span class="pre">ps</span> <span class="pre">-l</span> <span class="pre">#</span> <span class="pre">查看最后一次运行的容器</span>
<span class="pre">#</span> <span class="pre">退出容器</span>
<span class="pre">exit</span>
<span class="pre">#</span> <span class="pre">交互式容器exit退出后容器自动关闭</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-it</span> <span class="pre">--name</span> <span class="pre">[NAME]</span> <span class="pre">IMAGE</span> <span class="pre">/bin/bash</span>
<span class="pre">#</span> <span class="pre">创建守护式容器</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-itd</span> <span class="pre">--name</span> <span class="pre">NAME</span> <span class="pre">IMAGE</span> <span class="pre">/bin/bash</span>
<span class="pre">#</span> <span class="pre">进入容器</span>
<span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">[CONTAINER</span> <span class="pre">ID]</span> <span class="pre">/bin/bash</span>
<span class="pre">#</span> <span class="pre">启动已经停止的容器</span>
<span class="pre">docker</span> <span class="pre">start</span> <span class="pre">[CONTAINER</span> <span class="pre">ID]</span>
<span class="pre">#</span> <span class="pre">停止容器</span>
<span class="pre">docker</span> <span class="pre">stop</span> <span class="pre">[CONTAINER</span> <span class="pre">ID]</span>
<span class="pre">#</span> <span class="pre">重启容器</span>
<span class="pre">docker</span> <span class="pre">restart</span> <span class="pre">[CONTAINER</span> <span class="pre">ID]</span>
<span class="pre">#</span> <span class="pre">删除容器</span>
<span class="pre">docker</span> <span class="pre">rm</span> <span class="pre">-f</span> <span class="pre">[CONTAINER</span> <span class="pre">ID]</span>
<span class="pre">#</span> <span class="pre">删除全部停止的容器</span>
<span class="pre">docker</span> <span class="pre">rm</span> <span class="pre">`docker</span> <span class="pre">ps</span> <span class="pre">-a</span> <span class="pre">-q`</span>
<span class="pre">#</span> <span class="pre">查看容器详细信息</span>
<span class="pre">docker</span> <span class="pre">inspect</span> <span class="pre">[CONTAINER</span> <span class="pre">NAME]</span>
<span class="pre">#</span> <span class="pre">从宿主机（source）拷贝至容器内（target）：</span>
<span class="pre">docker</span> <span class="pre">cp</span> <span class="pre">./1.txt</span> <span class="pre">container1:/root</span>
<span class="pre">#</span> <span class="pre">从容器内（source）拷贝至宿主机（target）：</span>
<span class="pre">docker</span> <span class="pre">cp</span> <span class="pre">container1:/root</span> <span class="pre">./1.txt</span>
<span class="pre">#</span> <span class="pre">创建容器时指定-p参数将容器内端口映射到宿主机的端口。</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-itd</span> <span class="pre">--name=NAME</span> <span class="pre">-p</span> <span class="pre">宿主机端口:容器端口</span> <span class="pre">IMAGE</span> <span class="pre">/bin/bash</span>
<span class="pre">#</span> <span class="pre">创建容器时指定-v参数进行目录挂载。</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-itd</span> <span class="pre">--name=NAME</span> <span class="pre">-v</span> <span class="pre">宿主机目录:容器目录</span> <span class="pre">IMAGE</span> <span class="pre">/bin/bash</span>
<span class="pre">#</span> <span class="pre">镜像打包</span>
<span class="pre">docker</span> <span class="pre">save</span> <span class="pre">-o</span> <span class="pre">[dir/NAME.tar]</span> <span class="pre">IMAGE_NAME</span>
<span class="pre">#</span> <span class="pre">导入打包镜像</span>
<span class="pre">docker</span> <span class="pre">load</span> <span class="pre">-i</span> <span class="pre">/root/dir/NAME.tar</span>
<span class="pre">`</span></code></p>
<p>## 镜像管理</p>
<p>### 镜像是什么？</p>
<ul class="simple">
<li><p>一个分层存储的文件</p></li>
<li><p>一个软件的环境</p></li>
<li><p>一个镜像可以创建N个容器</p></li>
<li><p>一种标准化的交付(任何地方都可以执行这个镜像)</p></li>
<li><dl class="simple">
<dt>一个不包含Linux内核而又精简的Linux操作系统</dt><dd><p>镜像不是一个单一的文件，而是有多层构成。我们可以通过docker history &lt;ID/NAME&gt; 查看镜像中各层内容及大小，每层 对应着Dockerfile中的一条指令。Docker镜像默认存储在/var/lib/docker/&lt;storage-driver&gt;中。</p>
</dd>
</dl>
</li>
</ul>
<p>### <strong>镜像从哪里来?</strong></p>
<p>Docker Hub是由Docker公司负责维护的公共注册中心，包含大量的容器镜像，Docker工具默认从这个公共镜像库下载镜像。 地址:<a class="reference external" href="https://hub.docker.com/explore">https://hub.docker.com/explore</a></p>
<p>### <strong>镜像与容器联系</strong></p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190725213858.png">http://images.dregs.top/images/20190725213858.png</a>)</p>
<p>如图，容器其实是在镜像的最上面加了一层读写层，在运行容器里文件改动时，会先从镜像里要写的文件复制到容器自己的文件系统中(读写层)。如果容器删除了，最上面的读写层也就删除了，改动也就丢失了。所以无论多少个容器共享一个镜像，所做的写操作都是从镜像的文件系统中复制过来操作的，并不会修改镜像的源文件，这种方式提高磁盘利用率。</p>
<p>若想持久化这些改动，可以通过docker commit 将容器保存成一个新镜像</p>
<p>### <strong>管理镜像常用命令</strong></p>
<div class="line-block">
<div class="line">指令    | 描述                                | 示例                                     |</div>
<div class="line">——- | ———————————– | —————————————- |</div>
<div class="line">ls      | 列出镜像                            | docker image ls 或者 docker images       |</div>
<div class="line">build   | 构建镜像来自Dockerfile              | docker build -t nginx:v3 .               |</div>
<div class="line">history | 查看镜像历史                        | docker history tomcat:v1 查看构建历史    |</div>
<div class="line">inspect | 显示一个或多个镜像详细信息          | docker inspect tomcat:v1                 |</div>
<div class="line">pull    | 从镜像仓库拉去镜像                  | docker pull mysql:5.7 默认不加版本是最新 |</div>
<div class="line">push    | 推送一个镜像到镜像仓库              |                                          |</div>
<div class="line">rm      | 移除一个或多个镜像                  | docker image rm nginx 删除最新nginx镜像  |</div>
<div class="line">prune   | 移除未使用的镜像，没有被标记        |                                          |</div>
<div class="line">tag     | 创建一个引用源镜像标记目标镜像      |                                          |</div>
<div class="line">export  | 导出容器文件系统到tar归档文件       |                                          |</div>
<div class="line">import  | 导入容器文件tar归档文件创建镜像     |                                          |</div>
<div class="line">save    | 保存一个或多个镜像到一个tar归档文件 |                                          |</div>
<div class="line">load    | 加载镜像来自tar归档或标准输入       |                                          |</div>
</div>
<p>## 容器管理</p>
<p>### 创建容器常用选项</p>
<div class="line-block">
<div class="line">选项              | 描述                                                    |</div>
<div class="line">—————– | ——————————————————- |</div>
<div class="line">-i, –interactive  | 交互式                                                  |</div>
<div class="line">-t, –tty          | 分配一个伪终端                                          |</div>
<div class="line">-d, –detach       | 运行容器到后台                                          |</div>
<div class="line">-e, –env          | 设置环境变量                                            |</div>
<div class="line">-p, –publish list | 发布容器端口到主机                                      |</div>
<div class="line">-P, –publish-all  | 发布容器所有EXPOSE的端口到宿主机随机端口                |</div>
<div class="line">-name string      | 指定容器名称                                            |</div>
<div class="line">-h, –hostname     | 设置容器主机名                                          |</div>
<div class="line">-ip, string       | 指定容器ip，只能用于自定义网络                          |</div>
<div class="line">-network          | 连接容器到一个网络                                      |</div>
<div class="line">-mount, mount     | 将文件系统附加到容器                                    |</div>
<div class="line">-v, -volume list  | 绑定挂载一个卷                                          |</div>
<div class="line">-restart, string  | 容器退出时重启策略，默认no，可选值:[always|on-failure] |</div>
</div>
<p>### 容器资源限制</p>
<div class="line-block">
<div class="line">选项                       | 描述                                       |</div>
<div class="line">————————– | —————————————— |</div>
<div class="line">-m，–memory                | 容器可以使用的最大内存量                   |</div>
<div class="line">-memory-swap               | 允许交换到磁盘的内存量                     |</div>
<div class="line">-memory-swappiness=&lt;0-100&gt; | 容器使用SWAP分区交换的百分比(0-100，默认1) |</div>
<div class="line">-oom-kill-disable          | 禁用OOM Killer                             |</div>
<div class="line">-cpus                      | 可以使用的cpu数量                          |</div>
<div class="line">-cpuset-cpus               | 限制容器使用特定的cpu核心，如(0-3,0,1)     |</div>
<div class="line">-cpu-shares                | cpu共享(相对权重)                          |</div>
</div>
<p><strong>示例:
内存限额:</strong>
允许容器最多使用500M内存和100M的Swap，并禁用 OOM Killer:</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-d</span> <span class="pre">--name</span> <span class="pre">nginx03</span> <span class="pre">--memory=&quot;500m&quot;</span> <span class="pre">--memory-swap=“600m&quot;</span> <span class="pre">--oom-kill-disable</span> <span class="pre">nginx</span>
<span class="pre">`</span></code></p>
<p><strong>cpu限额</strong></p>
<p>允许容器最多使用一个半的CPU:</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-d</span> <span class="pre">--name</span> <span class="pre">nginx04</span> <span class="pre">--cpus=&quot;1.5&quot;</span> <span class="pre">nginx</span>
<span class="pre">`</span></code></p>
<p>允许容器最多使用50%的CPU：</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-d</span> <span class="pre">--name</span> <span class="pre">nginx05</span> <span class="pre">--cpus=&quot;.5&quot;</span> <span class="pre">nginx</span>
<span class="pre">`</span></code></p>
<p>### 管理容器常用命令</p>
<div class="line-block">
<div class="line">选项       | 描述                       | 示例 |</div>
<div class="line">———- | ————————– | —- |</div>
<div class="line">ls         | 列出容器                   |      |</div>
<div class="line">inspect    | 查看一个或多个容器详细信息 |      |</div>
<div class="line">exec       | 在运行容器中执行命令       |      |</div>
<div class="line">commit     | 创建一个新镜像来自一个容器 |      |</div>
<div class="line">cp         | 拷贝文件/文件夹到一个容器  |      |</div>
<div class="line">logs       | 获取一个容器日志           |      |</div>
<div class="line">port       | 列出或指定容器端口映射     |      |</div>
<div class="line">top        | 显示一个容器运行的进程     |      |</div>
<div class="line">stats      | 显示容器资源使用情况       |      |</div>
<div class="line">stop/start | 停止/启动一个或多个容器    |      |</div>
<div class="line">rm         | 删除一个或多个容器         |      |</div>
</div>
<p>## 管理应用程序数据</p>
<p>### 将数据从宿主机挂载到容器中的三种方式</p>
<p>Docker提供三种方式将数据从宿主机挂载到容器中:</p>
<ul class="simple">
<li><p>volumes:Docker管理宿主机文件系统的一部分(/var/lib/docker/volumes)。保存数据的最佳方式。</p></li>
<li><p>bind mounts:将宿主机上的任意位置的文件或者目录挂载到容器中。</p></li>
<li><p>tmpfs:挂载存储在主机系统的内存中，而不会写入主机的文件系统。如果不希望将数据持久存储在任何位置，可以使用 tmpfs，同时避免写入容器可写层提高性能。</p></li>
</ul>
<p>## Dockerfile</p>
<p>### Dockerfile指令</p>
<div class="line-block">
<div class="line">指令        | 描述                                                   |</div>
<div class="line">———– | —————————————————— |</div>
<div class="line">FROM        | 构建新镜像是基于哪个镜像                               |</div>
<div class="line">MAINTAINER  | 镜像维护者姓名或邮箱地址                               |</div>
<div class="line">RUN         | 构建镜像时运行的shell命令                              |</div>
<div class="line">COPY        | 拷贝文件或目录到镜像中                                 |</div>
<div class="line">ENV         | 设置环境变量                                           |</div>
<div class="line">USER        | 为RUN、CMD和ENTRYPOINT执行命令指定运行用户             |</div>
<div class="line">EXPOSE      | 声明容器运行的服务端口                                 |</div>
<div class="line">HEALTHCHECK | 容器中服务健康检查                                     |</div>
<div class="line">WORKDIR     | 为RUN、CMD、ENTRYPOINT、COPY和ADD设置工作目录          |</div>
<div class="line">ENTRYPOINT  | 运行容器时执行，如果有多个ENTRYPOINT指令，最后一个生效 |</div>
<div class="line">CMD         | 运行容器时执行，如果有多个CMD指令，最后一个生效        |</div>
</div>
<p>Dockerfile语法</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">Usage:</span> <span class="pre">docker</span> <span class="pre">build</span> <span class="pre">[OPTIONS]</span> <span class="pre">PATH</span> <span class="pre">|</span> <span class="pre">URL</span> <span class="pre">|</span> <span class="pre">-</span> <span class="pre">[flags]</span> <span class="pre">Options:</span>
<span class="pre">-t,</span> <span class="pre">--tag</span> <span class="pre">list</span> <span class="pre">#</span> <span class="pre">镜像名称</span>
<span class="pre">-f,</span> <span class="pre">--file</span> <span class="pre">string</span> <span class="pre">#</span> <span class="pre">指定Dockerfile文件位置</span>
<span class="pre">`</span></code></p>
<p>示例：</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">#</span> <span class="pre">docker</span> <span class="pre">build</span> <span class="pre">-t</span> <span class="pre">shykes/myapp</span> <span class="pre">.</span>
<span class="pre">#</span> <span class="pre">docker</span> <span class="pre">build</span> <span class="pre">-t</span> <span class="pre">shykes/myapp</span> <span class="pre">-f</span> <span class="pre">/path/Dockerfile</span> <span class="pre">/path</span>
<span class="pre">#</span> <span class="pre">docker</span> <span class="pre">build</span> <span class="pre">-t</span> <span class="pre">shykes/myapp</span> <span class="pre">http://www.exarmple.com/Dockerfile</span>
<span class="pre">`</span></code></p>
<p>### 构建业务基础镜像</p>
<p>#### 构建Nginx基础镜像</p>
<p>抒写dockerfile文件</p>
<p><a href="#id29"><span class="problematic" id="id30">``</span></a><a href="#id31"><span class="problematic" id="id32">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;blsnt">root<span>&#64;</span>blsnt</a> ~]# cd /server/tools
[<a class="reference external" href="mailto:root&#37;&#52;&#48;blsnt">root<span>&#64;</span>blsnt</a> tools]# cat Dockerfile-Nginx
FROM centos:7
ENV VERSION=1.15.5
MAINTAINER https://www.github/blsnt/blog
RUN yum install -y gcc gcc-c++ make </p>
<blockquote>
<div><p>openssl-devel pcre-devel gd-devel iproute net-tools telnet wget curl &amp;&amp; yum clean all &amp;&amp; rm -rf /var/cache/yum/*</p>
</div></blockquote>
<dl class="simple">
<dt>RUN wget <a class="reference external" href="http://nginx.org/download/nginx">http://nginx.org/download/nginx</a>-${VERSION}.tar.gz &amp;&amp; </dt><dd><p>tar zxf nginx-${VERSION}.tar.gz &amp;&amp; cd nginx-${VERSION} &amp;&amp; ./configure –prefix=/usr/local/nginx –with-http_ssl_module –with-http_stub_status_module &amp;&amp; make -j 4 &amp;&amp; make install &amp;&amp; rm -rf /usr/local/nginx/html/* &amp;&amp; echo “ok” &gt;&gt; /usr/local/nginx/html/status.html &amp;&amp; cd / &amp;&amp; rm -rf nginx-${VERSION}* &amp;&amp; ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</p>
</dd>
</dl>
<p>ENV PATH $PATH:/usr/local/nginx/sbin
COPY nginx.conf /usr/local/nginx/conf/nginx.conf
WORKDIR /usr/local/nginx
EXPOSE 80
CMD [“nginx”, “-g”, “daemon off;”]
<a href="#id33"><span class="problematic" id="id34">``</span></a><a href="#id35"><span class="problematic" id="id36">`</span></a></p>
<p>build构建</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;blsnt</span> <span class="pre">tools]#</span> <span class="pre">docker</span> <span class="pre">build</span> <span class="pre">-t</span> <span class="pre">nginx:v1</span> <span class="pre">-f</span> <span class="pre">Dockerfile-Nginx</span> <span class="pre">.</span>
<span class="pre">`</span></code></p>
<p>#### 构建PHP基础镜像</p>
<p><a href="#id37"><span class="problematic" id="id38">``</span></a><a href="#id39"><span class="problematic" id="id40">`</span></a>shell
FROM centos:7
MAINTAINER https://www.github/blsnt/blog
RUN yum install epel-release -y &amp;&amp; </p>
<blockquote>
<div><p>yum install -y gcc gcc-c++ make gd-devel libxml2-devel libcurl-devel libjpeg-devel libpng-devel openssl-devel libmcrypt-devel libxslt-devel libtidy-devel autoconf iproute net-tools telnet wget curl &amp;&amp; yum clean all &amp;&amp; rm -rf /var/cache/yum/*</p>
</div></blockquote>
<dl class="simple">
<dt>RUN wget <a class="reference external" href="http://docs.php.net/distributions/php-5.6.36.tar.gz">http://docs.php.net/distributions/php-5.6.36.tar.gz</a> &amp;&amp; </dt><dd><p>tar zxf php-5.6.36.tar.gz &amp;&amp; cd php-5.6.36 &amp;&amp; ./configure –prefix=/usr/local/php –with-config-file-path=/usr/local/php/etc –enable-fpm –enable-opcache –with-mysql –with-mysqli –with-pdo-mysql –with-openssl –with-zlib –with-curl –with-gd –with-jpeg-dir –with-png-dir –with-freetype-dir –enable-mbstring –with-mcrypt –enable-hash &amp;&amp; make -j 4 &amp;&amp; make install &amp;&amp; cp php.ini-production /usr/local/php/etc/php.ini &amp;&amp; cp sapi/fpm/php-fpm.conf /usr/local/php/etc/php-fpm.conf &amp;&amp; sed -i “90a daemonize = no” /usr/local/php/etc/php-fpm.conf &amp;&amp; mkdir /usr/local/php/log &amp;&amp; cd / &amp;&amp; rm -rf php* &amp;&amp; ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</p>
</dd>
</dl>
<p>ENV PATH $PATH:/usr/local/php/sbin
COPY php.ini /usr/local/php/etc/
COPY php-fpm.conf /usr/local/php/etc/
WORKDIR /usr/local/php
EXPOSE 9000
CMD [“php-fpm”]
<a href="#id41"><span class="problematic" id="id42">``</span></a><a href="#id43"><span class="problematic" id="id44">`</span></a></p>
<p>#### 构建Tomcat基础镜像</p>
<p><a href="#id45"><span class="problematic" id="id46">``</span></a><a href="#id47"><span class="problematic" id="id48">`</span></a>shell
FROM centos:7
MAINTAINER https://www.github/blsnt/blog</p>
<p>ENV VERSION=8.5.43</p>
<dl class="simple">
<dt>RUN yum install java-1.8.0-openjdk wget curl unzip iproute net-tools -y &amp;&amp; </dt><dd><p>yum clean all &amp;&amp; rm -rf /var/cache/yum/*</p>
</dd>
<dt>RUN wget <a class="reference external" href="http://mirror.bit.edu.cn/apache/tomcat/tomcat-8">http://mirror.bit.edu.cn/apache/tomcat/tomcat-8</a>/v${VERSION}/bin/apache-tomcat-${VERSION}.tar.gz &amp;&amp; </dt><dd><p>tar zxf apache-tomcat-${VERSION}.tar.gz &amp;&amp; mv apache-tomcat-${VERSION} /usr/local/tomcat &amp;&amp; rm -rf apache-tomcat-${VERSION}.tar.gz /usr/local/tomcat/webapps/* &amp;&amp; mkdir /usr/local/tomcat/webapps/test &amp;&amp; echo “ok” &gt; /usr/local/tomcat/webapps/test/status.html &amp;&amp; sed -i ‘1a JAVA_OPTS=”-Djava.security.egd=file:/dev/./urandom”’ /usr/local/tomcat/bin/catalina.sh &amp;&amp; ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</p>
</dd>
</dl>
<p>ENV PATH $PATH:/usr/local/tomcat/bin</p>
<p>WORKDIR /usr/local/tomcat</p>
<p>EXPOSE 8080
CMD [“catalina.sh”, “run”]
<a href="#id49"><span class="problematic" id="id50">``</span></a><a href="#id51"><span class="problematic" id="id52">`</span></a></p>
<p>#### 快速部署LNMP网站平台</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726123525.png">http://images.dregs.top/images/20190726123525.png</a>)</p>
<ul class="simple">
<li><p>自定义网络</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">network</span> <span class="pre">create</span> <span class="pre">lnmp</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>创建Mysql容器</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-d</span> <span class="pre">\</span>
<span class="pre">--name</span> <span class="pre">lnmp_mysql</span> <span class="pre">\</span>
<span class="pre">--net</span> <span class="pre">lnmp</span> <span class="pre">\</span>
<span class="pre">--mount</span> <span class="pre">src=mysql-vol,dst=/var/lib/mysql</span> <span class="pre">\</span>
<span class="pre">-e</span> <span class="pre">MYSQL_ROOT_PASSWORD=123456</span> <span class="pre">-e</span> <span class="pre">MYSQL_DATABASE=wordpress</span> <span class="pre">mysql:5.7</span> <span class="pre">--character-set-server=utf8</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>创建PHP容器</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-d</span> <span class="pre">\</span>
<span class="pre">--name</span> <span class="pre">lnmp_php</span> <span class="pre">\</span>
<span class="pre">--mount</span> <span class="pre">src=wwwroot,dst=/wwwroot</span> <span class="pre">php:v1</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>创建Nginx容器</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-d</span> <span class="pre">\</span>
<span class="pre">--name</span> <span class="pre">lnmp_nginx</span> <span class="pre">\</span>
<span class="pre">--net</span> <span class="pre">lnmp</span> <span class="pre">-p</span> <span class="pre">99:80</span> <span class="pre">\</span>
<span class="pre">--mount</span> <span class="pre">type=bind,src=$(pwd)/nginx.conf,dst=/usr/local/nginx/conf/nginx.conf</span> <span class="pre">\</span>
<span class="pre">--mount</span> <span class="pre">src=wwwroot,dst=/wwwroot</span> <span class="pre">nginx:v1</span>
<span class="pre">`</span></code></p>
<p>## 企业级镜像仓库Harbor</p>
<p>### harbor概述</p>
<p>Habor是由VMWare公司开源的容器镜像仓库。事实上，Habor是在Docker Registry上进行了相应的
企业级扩展，从而获得了更加广泛的应用，这些新的企业级特性包括:管理用户界面，基于角色的访
问控制 ，AD/LDAP集成以及审计日志等，足以满足基本企业需求。</p>
<p>[官方地址](<a class="reference external" href="https://vmware.github.io/harbor/cn/">https://vmware.github.io/harbor/cn/</a>)</p>
<div class="line-block">
<div class="line">组件               | 功能                                      |</div>
<div class="line">—————— | —————————————– |</div>
<div class="line">harbor-adminserver | 配置管理中心                              |</div>
<div class="line">harbor-db          | Mysql数据库                               |</div>
<div class="line">harbor-jobservice  | 负责镜像复制                              |</div>
<div class="line">harbor-log         | 记录操作日志                              |</div>
<div class="line">harbor-ui          | Web管理页面和API                          |</div>
<div class="line">nginx              | 前端代理，负责前端页面和镜像上传/下载转发 |</div>
<div class="line">redis              | 会话                                      |</div>
<div class="line">registry           | 镜像存储                                  |</div>
</div>
<p>### Harbor部署</p>
<p>[harbor下载地址](<a class="reference external" href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a>)</p>
<p>Harbor offline installer 离线安装</p>
<p>Harbor online installer 在线安装</p>
<p><strong>Harbor安装有3种方式:</strong></p>
<ul class="simple">
<li><p>在线安装:从Docker Hub下载Harbor相关镜像，因此安装软件包非常小</p></li>
<li><p>离线安装:安装包包含部署的相关镜像，因此安装包比较大</p></li>
<li><p>OVA安装程序:当用户具有vCenter环境时， 使用此程序，在部署OVA后启动Harbor</p></li>
</ul>
<p>安装docker-compose(如已安装请忽略)</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">curl</span> <span class="pre">-L</span> <span class="pre">https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname</span> <span class="pre">-s`-`uname</span> <span class="pre">-m`</span> <span class="pre">-o</span> <span class="pre">/usr/local/bin/docker-compose</span>
<span class="pre">chmod</span> <span class="pre">+x</span> <span class="pre">/usr/local/bin/docker-compose</span>
<span class="pre">`</span></code></p>
<p>安装harbor</p>
<p><a href="#id53"><span class="problematic" id="id54">``</span></a><a href="#id55"><span class="problematic" id="id56">`</span></a>shell
mkdir /application
cd /server/tools
tar xvf harbor-offline-installer-v1.6.1.tgz -C /application/
cd /application/harbor
vim harbor.cfg
hostname = 192.168.11.5
ui_url_protocol = http
harbor_admin_password = 123456</p>
<p>#安装
./install.sh
<a href="#id57"><span class="problematic" id="id58">``</span></a><a href="#id59"><span class="problematic" id="id60">`</span></a></p>
<p>&gt; 浏览器访问：192.168.11.5 即可</p>
<p>### 基本使用</p>
<ul class="simple">
<li><p>配置http镜像仓库可信任</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">vim</span> <span class="pre">/etc/docker/daemon.json</span>
<span class="pre">{&quot;registry-mirrors&quot;:</span> <span class="pre">[&quot;http://f1361db2.m.daocloud.io&quot;],</span>
<span class="pre">&quot;insecure-registries&quot;:[&quot;192.168.11.5&quot;]}</span>
<span class="pre">#重启docker</span>
<span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">docker</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>docker登录harbor</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">login</span> <span class="pre">192.168.11.5</span>
<span class="pre">Username:</span> <span class="pre">admin</span>
<span class="pre">Password:</span> <span class="pre">密码123456</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>打标签</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">tag</span> <span class="pre">centos:7</span> <span class="pre">192.168.11.5/obj/centos:v1</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>上传</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">push</span> <span class="pre">192.168.11.5/obj/centos:v1</span>
<span class="pre">`</span></code></p>
<ul class="simple">
<li><p>下载</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">docker</span> <span class="pre">pull</span> <span class="pre">192.168.11.5/obj/centos:v1</span>
<span class="pre">`</span></code></p>
<p>## <strong>Jenkins与Docker的自动化CI/CD流水线实战</strong></p>
<ul class="simple">
<li><p>什么是CI/CD</p></li>
</ul>
<p>持续集成(Continuous Integration，CI):代码合并、构建、部署、测试都在一起，不断地执行这个过程，并对结果反馈。
持续部署(Continuous Deployment，CD):部署到测试环境、预生产环境、生产环境。
持续交付(Continuous Delivery，CD):最终将产品发布到生产环境，给用户使用</p>
<ul class="simple">
<li><p>高效的CI/CD环境可以获得:
* 及时发现问题
* 大幅度减少故障率
* 加快迭代速度
* 减少时间成本</p></li>
<li><p>发布流程设计</p></li>
</ul>
<p>在如今的互联网时代，随着软件开发复杂度的不断提高，软件开发和发布管理也越来越重要。目前已经形成一套标准的流程，最重要的组成部分就是持续集成（Continuous Integration，CI）及持续部署、交付（CD）。在此，我们来以一个案例初步了解 CI 流程。那么什么是 CI 呢？简单来讲，CI 就是将传统的代码合并、构建、部署、测试都集成在一起，不断地执行这个过程，并对结果进行反馈。</p>
<p>CI 流程设计图：</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726192234.png">http://images.dregs.top/images/20190726192234.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726192254.png">http://images.dregs.top/images/20190726192254.png</a>)</p>
<ul class="simple">
<li><p>工作流程：
* 开发人员提交代码到Git版本仓库；
* Jenkins人工/定时触发项目构建；
* Jenkins拉取代码、代码编码、打包镜像、推送到镜像仓库；
* Jenkins在Docker主机创建容器并发布</p></li>
<li><p>主机环境规划</p></li>
</ul>
<div class="line-block">
<div class="line">主机          | 描述           |</div>
<div class="line">————- | ————– |</div>
<div class="line">192.168.11.12 | harbor镜像仓库 |</div>
<div class="line">192.168.11.11 | jenkins        |</div>
<div class="line">192.168.11.10 | git仓库        |</div>
</div>
<ul class="simple">
<li><p>部署Git仓库并上传测试代码</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;git</span> <span class="pre">~]#</span> <span class="pre">yum</span> <span class="pre">-y</span> <span class="pre">install</span> <span class="pre">git</span>
<span class="pre">[root&#64;git</span> <span class="pre">~]#</span> <span class="pre">useradd</span> <span class="pre">git</span>
<span class="pre">[root&#64;git</span> <span class="pre">~]#</span> <span class="pre">passwd</span> <span class="pre">git</span>
<span class="pre">[root&#64;git</span> <span class="pre">~]#</span> <span class="pre">su</span> <span class="pre">-</span> <span class="pre">git</span>
<span class="pre">[git&#64;git</span> <span class="pre">~]$</span> <span class="pre">mkdir</span> <span class="pre">tomcat-java-demo.git</span>
<span class="pre">[git&#64;git</span> <span class="pre">~]$</span> <span class="pre">cd</span> <span class="pre">tomcat-java-demo.git/</span>
<span class="pre">[git&#64;git</span> <span class="pre">tomcat-java-demo.git]$</span> <span class="pre">git</span> <span class="pre">--bare</span> <span class="pre">init</span>
<span class="pre">`</span></code></p>
<p>jenkins服务器拉取仓库并上传测试demo代码</p>
<p><a href="#id61"><span class="problematic" id="id62">``</span></a><a href="#id63"><span class="problematic" id="id64">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;jenkins">root<span>&#64;</span>jenkins</a> ~]# git clone <a class="reference external" href="mailto:git&#37;&#52;&#48;192&#46;168&#46;11&#46;10">git<span>&#64;</span>192<span>&#46;</span>168<span>&#46;</span>11<span>&#46;</span>10</a>:/home/git/tomcat-java-demo.git
正克隆到 ‘tomcat-java-demo’…
The authenticity of host ‘192.168.11.10 (192.168.11.10)’ can’t be established.
ECDSA key fingerprint is SHA256:N2N7OCqVPMqpzZjyh1FDTf2V0sWZvOCNgNKOWl8sPFo.
ECDSA key fingerprint is MD5:d9:73:f9:e2:05:b9:b4:7e:da:5e:c8:ff:22:61:19:0e.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added ‘192.168.11.10’ (ECDSA) to the list of known hosts.
git&#64;192.168.11.7’s password:
warning: 您似乎克隆了一个空版本库。
[root&#64;jenkins ~]# mv tomcat-java-demo/ tomcat-java-demo.bak
[root&#64;jenkins ~]# git clone https://github.com/dingkai163/tomcat-java-demo.git
[root&#64;jenkins tomcat-java-demo]# git config –global user.email “921390093&#64;qq.com”
[root&#64;jenkins tomcat-java-demo]# git config –global user.name “blsnt”
#修改仓库地址url
[root&#64;jenkins tomcat-java-demo]# cat .git/config
[core]</p>
<blockquote>
<div><p>repositoryformatversion = 0
filemode = true
bare = false
logallrefupdates = true</p>
</div></blockquote>
<dl class="simple">
<dt>[remote “origin”]</dt><dd><p>url = <a class="reference external" href="mailto:git&#37;&#52;&#48;192&#46;168&#46;11&#46;10">git<span>&#64;</span>192<span>&#46;</span>168<span>&#46;</span>11<span>&#46;</span>10</a>:/home/git/tomcat-java-demo.git
fetch = +refs/heads/<em>:refs/remotes/origin/</em></p>
</dd>
<dt>[branch “master”]</dt><dd><p>remote = origin
merge = refs/heads/master</p>
</dd>
</dl>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;jenkins">root<span>&#64;</span>jenkins</a> tomcat-java-demo]# git add .
[<a class="reference external" href="mailto:root&#37;&#52;&#48;jenkins">root<span>&#64;</span>jenkins</a> tomcat-java-demo]# git commit -m “update”
[<a class="reference external" href="mailto:root&#37;&#52;&#48;jenkins">root<span>&#64;</span>jenkins</a> tomcat-java-demo]# git push origin master
<a href="#id65"><span class="problematic" id="id66">``</span></a><a href="#id67"><span class="problematic" id="id68">`</span></a></p>
<ul class="simple">
<li><p>部署Harbor镜像仓库</p></li>
</ul>
<p>安装请参考上面有教程</p>
<p>构建Tomcat基础镜像，并推送到harbor镜像仓库</p>
<p><a href="#id69"><span class="problematic" id="id70">``</span></a><a href="#id71"><span class="problematic" id="id72">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;git">root<span>&#64;</span>git</a> tools]# cd /server/tools
[<a class="reference external" href="mailto:root&#37;&#52;&#48;git">root<span>&#64;</span>git</a> tools]# cat Dockerfile-tomcat
FROM centos:7
MAINTAINER https://www.github/blsnt/blog</p>
<p>ENV VERSION=8.5.43</p>
<dl class="simple">
<dt>RUN yum install java-1.8.0-openjdk wget curl unzip iproute net-tools -y &amp;&amp; </dt><dd><p>yum clean all &amp;&amp; rm -rf /var/cache/yum/*</p>
</dd>
<dt>RUN wget <a class="reference external" href="http://mirror.bit.edu.cn/apache/tomcat/tomcat-8">http://mirror.bit.edu.cn/apache/tomcat/tomcat-8</a>/v${VERSION}/bin/apache-tomcat-${VERSION}.tar.gz &amp;&amp; </dt><dd><p>tar zxf apache-tomcat-${VERSION}.tar.gz &amp;&amp; mv apache-tomcat-${VERSION} /usr/local/tomcat &amp;&amp; rm -rf apache-tomcat-${VERSION}.tar.gz /usr/local/tomcat/webapps/* &amp;&amp; sed -i ‘1a JAVA_OPTS=”-Djava.security.egd=file:/dev/./urandom”’ /usr/local/tomcat/bin/catalina.sh &amp;&amp; ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</p>
</dd>
</dl>
<p>ENV PATH $PATH:/usr/local/tomcat/bin</p>
<p>WORKDIR /usr/local/tomcat</p>
<p>EXPOSE 8080
CMD [“catalina.sh”, “run”]
[<a class="reference external" href="mailto:root&#37;&#52;&#48;git">root<span>&#64;</span>git</a> tools]# docker build -t tomcat:v1 -f Dockerfile-tomcat .
[root&#64;git tools]# docker tag tomcat:v1 192.168.11.12/obj/tomcat:v1
[root&#64;git tools]# docker login 192.168.11.12
[root&#64;git tools]# docker push 192.168.11.12/obj/tomcat:v1
<a href="#id73"><span class="problematic" id="id74">``</span></a><a href="#id75"><span class="problematic" id="id76">`</span></a></p>
<ul class="simple">
<li><p>准备Jenkins环境并配置全局工具</p></li>
</ul>
<p>部署jdk环境及maven</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">~]#</span> <span class="pre">mkdir</span> <span class="pre">/server/tools</span> <span class="pre">-p</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">~]#</span> <span class="pre">cd</span> <span class="pre">/server/tools</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">tar</span> <span class="pre">xf</span> <span class="pre">jdk-8u45-linux-x64.tar.gz</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">mv</span> <span class="pre">jdk1.8.0_45/</span> <span class="pre">/usr/local/jdk</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">vim</span> <span class="pre">/etc/profile</span>
<span class="pre">JAVA_HOME=/usr/local/jdk</span>
<span class="pre">PATH=$PATH:$JAVA_HOME/bin</span>
<span class="pre">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span>
<span class="pre">export</span> <span class="pre">JAVA_HOME</span> <span class="pre">PATH</span> <span class="pre">CLASSPATH</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">source</span> <span class="pre">/etc/profile</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">java</span> <span class="pre">-version</span>
<span class="pre">java</span> <span class="pre">version</span> <span class="pre">&quot;1.8.0_45&quot;</span>
<span class="pre">Java(TM)</span> <span class="pre">SE</span> <span class="pre">Runtime</span> <span class="pre">Environment</span> <span class="pre">(build</span> <span class="pre">1.8.0_45-b14)</span>
<span class="pre">Java</span> <span class="pre">HotSpot(TM)</span> <span class="pre">64-Bit</span> <span class="pre">Server</span> <span class="pre">VM</span> <span class="pre">(build</span> <span class="pre">25.45-b02,</span> <span class="pre">mixed</span> <span class="pre">mode)</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">tar</span> <span class="pre">xf</span> <span class="pre">apache-maven-3.5.0-bin.tar.gz</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">mv</span> <span class="pre">apache-maven-3.5.0</span> <span class="pre">/usr/local/maven</span>
<span class="pre">`</span></code></p>
<p>安装jenkins，下载tomcat二进制包将war包放到webapps下即可</p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">wget</span> <span class="pre">http://mirrors.jenkins.io/war-stable/latest/jenkins.war</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">wget</span> <span class="pre">http://mirror.bit.edu.cn/apache/tomcat/tomcat-8/v8.5.43/bin/apache-tomcat-8.5.43.tar.gz</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">mv</span> <span class="pre">apache-tomcat-8.5.43</span> <span class="pre">/usr/local/tomcat-jenkins</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">/usr/local/tomcat-jenkins/webapps/*</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">mv</span> <span class="pre">jenkins.war</span> <span class="pre">/usr/local/tomcat-jenkins/webapps/ROOT.war</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">tools]#</span> <span class="pre">cd</span> <span class="pre">/usr/local/tomcat-jenkins/bin/</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">bin]#</span> <span class="pre">./startup.sh</span>
<span class="pre">#获取密码</span>
<span class="pre">[root&#64;jenkins</span> <span class="pre">bin]#</span> <span class="pre">tail</span> <span class="pre">-f</span> <span class="pre">/usr/local/tomcat-jenkins/logs/catalina.out</span>
<span class="pre">af3faf779b96470ebdefa82338d478cc</span>
<span class="pre">`</span></code></p>
<p>启动后，浏览器访问http://192.168.11.11:8080/，按提示输入密码，登录即可</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726214652.png">http://images.dregs.top/images/20190726214652.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726215004.png">http://images.dregs.top/images/20190726215004.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726215058.png">http://images.dregs.top/images/20190726215058.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726215129.png">http://images.dregs.top/images/20190726215129.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726215149.png">http://images.dregs.top/images/20190726215149.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726215252.png">http://images.dregs.top/images/20190726215252.png</a>)</p>
<ul class="simple">
<li><p>Jenkins安装必要插件</p></li>
</ul>
<p>由于jenkins是离线安装，所有在此需要配置一下插件下载地址：系统管理–&gt;插件管理–&gt;Advanced</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726233014.png">http://images.dregs.top/images/20190726233014.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726233101.png">http://images.dregs.top/images/20190726233101.png</a>)</p>
<p>修改下方地址，将https修改为http 再点Submit</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726233129.png">http://images.dregs.top/images/20190726233129.png</a>)</p>
<p>Submit后点击Available，Check now此时我们可以看到很多可获得插件</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726233154.png">http://images.dregs.top/images/20190726233154.png</a>)</p>
<p>首先搜索并安装Pipeline插件
pipeline 是一套运行于jenkins上的工作流框架，将原本独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排与 可视化。</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190726233224.png">http://images.dregs.top/images/20190726233224.png</a>)</p>
<p>再安装SCM to job 插件 git 插件，同上步骤（搜索，安装）。</p>
<ul class="simple">
<li><p>项目创建</p></li>
</ul>
<p>创建jobs</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727153921.png">http://images.dregs.top/images/20190727153921.png</a>)</p>
<p>选择流水线类型</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727154356.png">http://images.dregs.top/images/20190727154356.png</a>)</p>
<p>到这里我们就开始配置Pipeline script，点击Pipeline语法，来自动生成我们需要的配置。</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727154422.png">http://images.dregs.top/images/20190727154422.png</a>)</p>
<p>如下图，我们Git方式，配置Git仓库地址，再添加认证相关。</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727154913.png">http://images.dregs.top/images/20190727154913.png</a>)</p>
<p>这里我们使用的是秘钥认证方式，需要将jenkins上生成的公钥发送到git服务器上，然后将jenkins上的生成的私钥内容粘贴到下图Key中，这样jenkins就可以免交互的拉取git仓库中的代码了。</p>
<p><a href="#id77"><span class="problematic" id="id78">``</span></a><a href="#id79"><span class="problematic" id="id80">`</span></a>shell
[<a class="reference external" href="mailto:root&#37;&#52;&#48;jenkins">root<span>&#64;</span>jenkins</a> ~]# ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:Ft/CWmT6wzqzOvR5qpf6/OsGoEkVdRtBs9pnftS9pt8 root&#64;jenkins
The key’s randomart image is:
+—[RSA 2048]—-+
|      .o..*.     |
|      .  . =     |
|     .  . =      |
|    . .  X .   ..|
|   . o .S * + . o|
|    o …= = .  .|
|     . ..++ . .o |
|      ..B.o. .o .|
|      +B*X+. …E|
+—-[SHA256]—–+</p>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;jenkins">root<span>&#64;</span>jenkins</a> ~]# ssh-copy-id <a class="reference external" href="mailto:git&#37;&#52;&#48;192&#46;168&#46;11&#46;11">git<span>&#64;</span>192<span>&#46;</span>168<span>&#46;</span>11<span>&#46;</span>11</a>
<a href="#id81"><span class="problematic" id="id82">``</span></a><a href="#id83"><span class="problematic" id="id84">`</span></a></p>
<p>jenkins添加私钥</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727155452.png">http://images.dregs.top/images/20190727155452.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727155546.png">http://images.dregs.top/images/20190727155546.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727155643.png">http://images.dregs.top/images/20190727155643.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727155743.png">http://images.dregs.top/images/20190727155743.png</a>)</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727155409.png">http://images.dregs.top/images/20190727155409.png</a>)</p>
<p>Pipeline生成代码</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727155958.png">http://images.dregs.top/images/20190727155958.png</a>)</p>
<p>配置完成后，我们就可以生成Pipeline脚本了。点击下方Generate Pipeline Script，然后复制方框内的内容</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727160053.png">http://images.dregs.top/images/20190727160053.png</a>)</p>
<p>编写我们所需要的Pipeline脚本如下，将其粘贴到script的拉取代码模块中，并修改分支master为${branch}，其他模块内容自行编写。</p>
<p><a href="#id85"><span class="problematic" id="id86">``</span></a><a href="#id87"><span class="problematic" id="id88">`</span></a>shell
node {</p>
<blockquote>
<div><p>// 拉取代码
stage(‘Git Checkout’) {</p>
<blockquote>
<div><p>checkout([$class: ‘GitSCM’, branches: [[name: ‘$branch’]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: ‘3fc081d3-be7d-442a-b955-f6860086b88b’, url: <a class="reference external" href="mailto:'git&#37;&#52;&#48;192&#46;168&#46;11&#46;10">‘git<span>&#64;</span>192<span>&#46;</span>168<span>&#46;</span>11<span>&#46;</span>10</a>:/home/git/tomcat-java-demo.git’]]])</p>
</div></blockquote>
<p>}
// 代码编译
stage(‘Maven Build’) {</p>
<blockquote>
<div><p>sh ‘’’
export JAVA_HOME=/usr/local/jdk
/usr/local/maven/bin/mvn clean package -Dmaven.test.skip=true
‘’’</p>
</div></blockquote>
<p>}
// 项目打包到镜像并推送到镜像仓库
stage(‘Build and Push Image’) {</p>
</div></blockquote>
<p>sh ‘’’
REPOSITORY=192.168.11.12/obj/tomcat-java-demo:${branch}
cat &gt; Dockerfile &lt;&lt; EOF
FROM 192.168.11.12/obj/tomcat:v1
MAINTAINER blsnt
RUN rm -rf /usr/local/tomcat/webapps/*
ADD target/<a href="#id89"><span class="problematic" id="id90">*</span></a>.war /usr/local/tomcat/webapps/ROOT.war
EOF
docker build -t $REPOSITORY .
docker login 192.168.11.12 -u admin -p 12345
docker push $REPOSITORY
‘’’</p>
<blockquote>
<div><p>}
// 部署到Docker主机,远程主机的话可以使用ssh登录执行命令
stage(‘Deploy to Docker’) {</p>
<blockquote>
<div><p>sh ‘’’
REPOSITORY=192.168.11.12/obj/tomcat-java-demo:${branch}
docker rm -f tomcat-java-demo <a href="#id91"><span class="problematic" id="id92">|</span></a>true
docker pull $REPOSITORY
docker container run -d –name tomcat-java-demo -p 88:8080 $REPOSITORY
‘’’</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<div class="section" id="id93">
<h1><span class="section-number">1. </span>}<a class="headerlink" href="#id93" title="Permalink to this headline">¶</a></h1>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727233430.png">http://images.dregs.top/images/20190727233430.png</a>)</p>
<p>在Pipeline脚本里面我们指定了一个branch参数，所以我们需要传递一个参数变量，这里我们选择参数化构建，默认值为master分支。</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727233503.png">http://images.dregs.top/images/20190727233503.png</a>)</p>
<p>然后保存配置</p>
<p>开始构建</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727233528.png">http://images.dregs.top/images/20190727233528.png</a>)</p>
<p>可以通过Console Output输出查看jenkins构建流程</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727233640.png">http://images.dregs.top/images/20190727233640.png</a>)</p>
<p>成功构建会提示： SUCCESS</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727233734.png">http://images.dregs.top/images/20190727233734.png</a>)</p>
<p>我们也可以查看构建成功后的图形构建过程</p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727233757.png">http://images.dregs.top/images/20190727233757.png</a>)</p>
<p>通过浏览器来访问tomcat-java-demo项目：<a class="reference external" href="http://192.168.11.11:88/">http://192.168.11.11:88/</a></p>
<p>![](<a class="reference external" href="http://images.dregs.top/images/20190727233853.png">http://images.dregs.top/images/20190727233853.png</a>)</p>
<p>部署完成</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Docker基础与使用" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, 小义同学

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>